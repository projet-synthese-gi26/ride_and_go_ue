# Contexte du Projet : Fleet & Geofence API
GÃ©nÃ©rÃ© le : Tue 30 Dec 2025 01:07:34 AM WAT
Framework : Spring Boot WebFlux (Reactive)

## 1. Arborescence du Projet
```
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docs
â”‚Â Â  â”œâ”€â”€ context
â”‚Â Â  â”‚Â Â  â””â”€â”€ project_context.txt
â”‚Â Â  â”œâ”€â”€ prompts
â”‚Â Â  â”‚Â Â  â””â”€â”€ master_pair_programmer.md
â”‚Â Â  â”œâ”€â”€ roadmaps
â”‚Â Â  â”‚Â Â  â””â”€â”€ todo.md
â”‚Â Â  â””â”€â”€ specs
â”‚Â Â      â””â”€â”€ spec.md
â”œâ”€â”€ .gitattributes
â”œâ”€â”€ .github
â”‚Â Â  â””â”€â”€ workflows
â”‚Â Â      â””â”€â”€ ci-cd.yml
â”œâ”€â”€ .gitignore
â”œâ”€â”€ import_context.sh
â”œâ”€â”€ mvnw
â”œâ”€â”€ mvnw.cmd
â”œâ”€â”€ pom.xml
â”œâ”€â”€ Readme.md
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚Â Â  â”œâ”€â”€ java
    â”‚Â Â  â”‚Â Â  â””â”€â”€ com
    â”‚Â Â  â”‚Â Â      â””â”€â”€ yowyob
    â”‚Â Â  â”‚Â Â          â””â”€â”€ rideandgo
    â”‚Â Â  â”‚Â Â              â”œâ”€â”€ application
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ service
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FareService.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OfferService.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ UserService.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ utils
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ Constants.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ Utils.java
    â”‚Â Â  â”‚Â Â              â”œâ”€â”€ domain
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ exception
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OfferNotFoundException.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OfferStatutNotMatchException.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TokenNotFoundException.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ UserIsNotDriverException.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ model
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ enums
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OfferState.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RideState.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ RoleType.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Fare.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Offer.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Permission.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Ride.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Role.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ User.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ ports
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ in
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ AcceptedOfferUseCase.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ CreateOfferUseCase.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ PutFareInCacheUseCase.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ResponseToOfferUseCase.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â””â”€â”€ UserUseCases.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ out
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ FareCachePort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ FareClientPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ OfferCachePort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ OfferEventPublisherPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ OfferRepositoryPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ RideRepositoryPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ RoleRepositoryPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ SendNotificationPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ StockClientPort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ UserCachePort.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â          â””â”€â”€ UserRepositoryPort.java
    â”‚Â Â  â”‚Â Â              â”œâ”€â”€ infrastructure
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ adapters
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ inbound
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kafka
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ kafkaAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ rest
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ dto
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ CreateOfferRequest.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ CreateUserRequest.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ FareRequest.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ FareResponse.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ NotificationType.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ OfferResponse.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ RideResponse.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ SendNotificationRequest.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ UserResponse.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ FareController.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ GlobalExceptionHandler.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ HealthCheckController.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ OfferController.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ UserController.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ outbound
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ cache
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ RedisAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ external
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ client
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ FareCalculatorClient.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ FareAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ messaging
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ OfferEventPublisherAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ SendNotificationAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â””â”€â”€ persistence
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ entity
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ AbstractAuditingEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OfferAgreementEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OfferEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ PermissionEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ RideEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ RoleEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ UserEntity.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ OfferR2dbcAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ repository
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OfferAgreementR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ OfferR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ PermissionR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ RideR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ RoleR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ UserR2dbcRepository.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ RideR2dbcAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ RoleR2dbcAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â””â”€â”€ UserR2dbcAdapter.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ config
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ DatabaseInitConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ KafkaConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OpenApiConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RedisConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ SecurityConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ WebClientConfig.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ mappers
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ FareMapper.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ OfferMapper.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ RideMapper.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ RoleMapper.java
    â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ UserMapper.java
    â”‚Â Â  â”‚Â Â              â”œâ”€â”€ RideAndGoApplication.java
    â”‚Â Â  â”‚Â Â              â””â”€â”€ tmp
    â”‚Â Â  â””â”€â”€ resources
    â”‚Â Â      â”œâ”€â”€ application.yml
    â”‚Â Â      â”œâ”€â”€ local
    â”‚Â Â      â”‚Â Â  â”œâ”€â”€ data.sql
    â”‚Â Â      â”‚Â Â  â””â”€â”€ schema.sql
    â”‚Â Â      â””â”€â”€ prod.application.yml
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ com
                â””â”€â”€ yowyob
                    â””â”€â”€ reactive_hexagonal
                        â””â”€â”€ ReactiveHexagonalApplicationTests.java

46 directories, 102 files
```
## 2. Contenu des Fichiers

---
### Fichier : `./bin/src/main/resources/application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: reactive-hexagonal
  
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/reactivedb
    username: user
    password: password
  
  sql:
    init:
      mode: always # start the scheme

  data:
    redis:
      host: localhost
      port: 6379

  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# Custom Config 
application:
  external:
    stock-service-url: http://localhost:8081 # Wiremock

# Resilience4j Config
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5```

---
### Fichier : `./bin/src/main/resources/schema.sql`
```sql
CREATE TABLE IF NOT EXISTS products (
    id UUID PRIMARY KEY,
    name VARCHAR(255),
    price DECIMAL(10, 2),
    status VARCHAR(50)
);```

---
### Fichier : `./bin/.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./bin/pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>```

---
### Fichier : `./docs/specs/spec.md`
```md
# ðŸ“„ SpÃ©cifications Techniques : API RIDE & GO (Sprint Express)

## 1. PrÃ©sentation du projet
**Ride & Go** est une marketplace de transport urbain (VTC/Taxi). 
*   **Le Passager (Client)** : Calcule un coÃ»t estimÃ©, publie une offre de trajet.
*   **Le Chauffeur (Driver)** : Parcourt les offres disponibles et postule (Bidding).
*   **Le SystÃ¨me** : GÃ¨re la transition de l'offre vers une course rÃ©elle (Trip) une fois le chauffeur validÃ©.
*   **Stack** : Backend Spring Boot (Architecture Hexagonale) & Frontend React Native.

---

## 2. ModÃ©lisation des donnÃ©es & Ã‰tats (English)

### A. Offer States (Annonce client)
1.  `PENDING` : Offre crÃ©Ã©e, en attente de chauffeurs.
2.  `BID_RECEIVED` : Au moins un chauffeur a postulÃ©.
3.  `DRIVER_SELECTED` : Le passager a choisi un chauffeur.
4.  `VALIDATED` : Le chauffeur a acceptÃ© le choix, l'offre devient un "Trip".
5.  `CANCELLED` : AnnulÃ©e par le client ou expiration.

### B. Trip States (La course)
1.  `CREATED` : Course initialisÃ©e, chauffeur en route vers le client.
2.  `ONGOING` : Client rÃ©cupÃ©rÃ©, trajet en cours vers la destination.
3.  `COMPLETED` : ArrivÃ©e Ã  destination, paiement confirmÃ©.
4.  `CANCELLED` : Course interrompue.

---

Voici la section 3 mise Ã  jour de faÃ§on exhaustive, en reprenant chaque action simple de ton brouillon et en y associant la route correspondante pour que ton binÃ´me et toi sachiez exactement quoi appeler Ã  chaque Ã©tape.

---

## 3. Flux Principal (User Journey & Route Mapping)

### 1. Auth : Identification des utilisateurs
*   **S'enregistrer** : Le chauffeur ou le passager crÃ©e son compte (`POST /api/auth/register`).
*   **Se connecter** : L'utilisateur accÃ¨de Ã  l'application et rÃ©cupÃ¨re son token (`POST /api/auth/login`).

### 2. Estimate : PrÃ©paration du trajet (CÃ´tÃ© Client)
*   **Calculer le coÃ»t** : Le client saisit son trajet pour obtenir une estimation via le service externe (`POST /api/fares/estimate`).

    Endpoint principal d'estimation de prix.
    
    **FlexibilitÃ© des paramÃ¨tres :**
    - Les coordonnÃ©es (`lat`/`lon`) sont **optionnelles** si un nom de lieu (`label`) est fourni.
    - L'API effectuera un gÃ©ocodage automatique si nÃ©cessaire.
    - Les paramÃ¨tres `heure`, `meteo`, `type_zone` sont **optionnels** (dÃ©tectÃ©s automatiquement si omis).
    
    **Exemple minimaliste (Noms de lieux uniquement) :**
    ```json
    {
        "depart": {"label": "Poste Centrale"},
        "arrivee": {"label": "Mvan"}
    }
    ```
    response:

    {
"depart": "string",
"arrivee": "string",
"heure": "matin",
"meteo": 3,
"type_zone": 2,
"congestion_user": 10
}

*   **Visualiser l'estimation** : Le systÃ¨me renvoie le prix suggÃ©rÃ© et la distance pour aider le client Ã  fixer son offre.

### 3. Post Offer : Publication (CÃ´tÃ© Client)
*   **CrÃ©er l'offre** : Le client publie son offre avec le prix dÃ©finitif (`POST /api/offers`). -> Ã‰tat `PENDING`.
*   **Notifier les chauffeurs** : Le systÃ¨me rend l'offre visible pour les chauffeurs aux alentours. 

### 4. Bidding : Manifestation d'intÃ©rÃªt (CÃ´tÃ© Chauffeur)
*   **Recevoir les clients** : Le chauffeur consulte la liste des offres/clients disponibles dans sa zone (`GET /api/offers/available`).
*   **Postuler Ã  une offre** : Le chauffeur choisit une offre et envoie sa candidature (`POST /api/offers/{id}/apply`). -> Ã‰tat `BID_RECEIVED`.

### 5. Selection : Validation du binÃ´me (CÃ´tÃ© Client)
*   **Recevoir les chauffeurs** : Le client consulte la liste de tous les chauffeurs qui ont postulÃ© Ã  son offre (`GET /api/offers/{id}/bids`).
*   **Valider un chauffeur** : Le client choisit son chauffeur prÃ©fÃ©rÃ© parmi la liste (`PATCH /api/offers/{id}/select-driver`). -> Ã‰tat `DRIVER_SELECTED`.

C'est un point crucial pour l'expÃ©rience utilisateur. Voici le bloc **6. Trip Execution** mis Ã  jour pour intÃ©grer explicitement le suivi GPS pendant la phase d'approche (quand le chauffeur vient chercher le client) :

---

### 6. Trip Execution : DÃ©roulement de la course

*   **Initialiser la course** : Suite Ã  la sÃ©lection, le systÃ¨me crÃ©e le contexte de trajet (`POST /api/trips`). -> Ã‰tat **`CREATED`**.
*   **Phase d'approche (Tracking)** : Pendant que le chauffeur se dÃ©place vers le point de dÃ©part pour rÃ©cupÃ©rer le client :
    *   **Envoi GPS (Chauffeur)** : Le chauffeur envoie sa position GPS en temps rÃ©el pour signaler sa progression (`POST /api/trips/{id}/location`).
    *   **Suivi de l'approche (Client)** : Le client suit en direct l'arrivÃ©e du chauffeur sur sa carte pour savoir exactement quand il sera lÃ  (`GET /api/trips/{id}/location`).
*   **DÃ©marrer le trajet (Pickup)** : Une fois le client rÃ©cupÃ©rÃ©, le chauffeur confirme le dÃ©but de la course dans l'app (`PATCH /api/trips/{id}/status` avec body `{ "status": "ONGOING" }`). -> Ã‰tat **`ONGOING`**.
*   **Phase de trajet (Tracking continu)** : Pendant que le client est Ã  bord jusqu'Ã  la destination :
    *   **Mise Ã  jour GPS** : Le chauffeur continue d'envoyer sa position (`POST /api/trips/{id}/location`).
    *   **Consultation trajet** : Le client (et le systÃ¨me) suit le bon dÃ©roulement du trajet sur la carte (`GET /api/trips/{id}/location`).
*   **Terminer le trajet** : ArrivÃ© Ã  destination, le chauffeur clÃ´ture la course pour dÃ©clencher la facturation (`PATCH /api/trips/{id}/status` avec body `{ "status": "COMPLETED" }`). -> Ã‰tat **`COMPLETED`**.

---

**Astuce pour le code :**
Dans vos applications mobiles (React Native), utilisez un `setInterval` de **5 secondes** :
1.  **CÃ´tÃ© Chauffeur** : Pour appeler le `POST` de localisation.
2.  **CÃ´tÃ© Client** : Pour appeler le `GET` de localisation et mettre Ã  jour le marqueur (icÃ´ne voiture) sur la carte.

---

## 4. Contrats d'API (RequÃªtes & RÃ©ponses)

### I. Authentification (Service Externe)

**POST** `/api/auth/register`
*Request Body:*
```json
{
"username": "string",
"password": "stringst",
"email": "string",
"phone": "stringst",
"firstName": "string",
"lastName": "string",
"service": "RIDE_AND_GO",
"roles": [
    "string"
]
}
```
*Response (201):*
```json
{
"accessToken": "string",
"refreshToken": "string",
"user": {
    "id": "string",
    "username": "string",
    "email": "string",
    "phone": "string",
    "firstName": "string",
    "lastName": "string",
    "service": "LETS_GO",
    "roles": [
    "string"
    ],
    "permissions": [
    "string"
    ]
}
}
```

**POST** `/api/auth/login`
*Request Body:*
```json
{
"identifier": "nomo",
"password": "gabriel123"
}
```
*Response (200):*
```json
{
"accessToken": "eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIxMjU1YTgyMy1iNWE0LTQ3MzEtOGQ2OC1iZGY0ZTM2MmMwYjciLCJzdWIiOiJmMGExMjQ2NC0zZGY1LTQ5NDgtYjIzMi1lNGMwYjBhMWZmOGQiLCJpc3MiOiJhdXRoLXNlcnZpY2UiLCJ1c2VybmFtZSI6Im5vbW8iLCJwZXJtaXNzaW9ucyI6W10sInJvbGVzIjpbIkFETUlOIl0sImlhdCI6MTc2Njk5NTI0MSwiZXhwIjoxNzY2OTk2MTQxfQ.XuUaVcZXuZpgxY_sT3vnVBSSnhdACljfU4d8trrI0j4",
"refreshToken": "eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiJjMzAzMTE1Ni02MzRkLTRlMGQtODA3Yi1mZTliMmQ4NWY2ZTgiLCJzdWIiOiJmMGExMjQ2NC0zZGY1LTQ5NDgtYjIzMi1lNGMwYjBhMWZmOGQiLCJpc3MiOiJhdXRoLXNlcnZpY2UiLCJpYXQiOjE3NjY5OTUyNDEsImV4cCI6MTc2OTU4NzI0MX0.lPakd_x7ckCI2az32ni1dAcs8ut-9MmcjfCLPySC4Zg",
"user": {
    "id": "f0a12464-3df5-4948-b232-e4c0b0a1ff8d",
    "username": "nomo",
    "email": "gabriel@test.com",
    "phone": "612345678",
    "firstName": "gabriel",
    "lastName": "gabriel",
    "service": "LETS_GO",
    "roles": [
    "ADMIN"
    ],
    "permissions": []
}
}

refresh token `/api/auth/refresh`

`json
    {
"refreshToken": "string"
}
`
```

---

### II. Calcul des coÃ»ts (Service Externe / Fallback)


**POST** `/api/fares/estimate`
Endpoint principal d'estimation de prix.
    
    **FlexibilitÃ© des paramÃ¨tres :**
    - Les coordonnÃ©es (`lat`/`lon`) sont **optionnelles** si un nom de lieu (`label`) est fourni.
    - L'API effectuera un gÃ©ocodage automatique si nÃ©cessaire.
    - Les paramÃ¨tres `heure`, `meteo`, `type_zone` sont **optionnels** (dÃ©tectÃ©s automatiquement si omis).
    
    **Exemple minimaliste (Noms de lieux uniquement) :**
    ```json
    {
        "depart": {"label": "Poste Centrale"},
        "arrivee": {"label": "Mvan"}
    }
    ```
*Request Body:*
```json
{
"depart": "string",
"arrivee": "string",
"heure": "matin",
"meteo": 3,
"type_zone": 2,
"congestion_user": 10
}
```
*Response (200):*
```json
{
"statut": "exact",
"prix_moyen": 0,
"prix_min": 0,
"prix_max": 0,
"distance": 0,
"duree": 0,
"estimations_supplementaires": {
    "ml_prediction": 0,
    "features_utilisees": {
    "distance_metres": 0,
    "duree_secondes": 0,
    "congestion": 0,
    "sinuosite": 0,
    "nb_virages": 0,
    "heure": "string",
    "meteo": 0,
    "type_zone": 0
    }
},
"ajustements_appliques": {
    "additionalProp1": "string",
    "additionalProp2": "string",
    "additionalProp3": "string"
},
"fiabilite": 1,
"message": "string",
"details_trajet": {
    "additionalProp1": "string",
    "additionalProp2": "string",
    "additionalProp3": "string"
},
"suggestions": [
    "string"
]
}
```

---

### III. Gestion des Offres (CÃ´tÃ© Passager)

**POST** `/api/offers`
*Request Body:*
```json
{
"passengerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
"startPoint": "string",
"endPoint": "string",
"price": 0,
"state": "NEW"
}
```
*Response (201):*
```json
{
"id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
"passengerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
"startPoint": "string",
"endPoint": "string",
"price": 0,
"state": "NEW",
"interestedDrivers": [
    "3fa85f64-5717-4562-b3fc-2c963f66afa6"
]
}
```

**GET** `/api/offers/{id}/bids`
*Response (200):*
```json
[
{
    "driverId": "uuid-driver-1",
    "driverName": "Eto'o Fils",
    "carModel": "Toyota Avensis",
    "rating": 4.8,
    "eta": "5 min"
},
{
    "driverId": "uuid-driver-2",
    "driverName": "Aboubakar",
    "carModel": "Hyundai Elantra",
    "rating": 4.5,
    "eta": "8 min"
}
] // a bien concevoir
```

**PATCH** `/api/offers/{id}/select-driver`
voir image piece jointe
```

---

### IV. Gestion des Offres (CÃ´tÃ© Chauffeur)

**GET** `/api/offers/available`
*Response (200):*
```json
[
{
    "id": "uuid-offer-1",
    "origin": "Bastos",
    "destination": "Poste",
    "price": 2500,
    "timestamp": "2025-12-29T10:00:00Z"
}
]
```

**POST** `/api/offers/{id}/apply`
*Request Body:*
```json
{
"driverId": "uuid-driver",
"estimatedArrivalTime": 6 // temps en minutes
}
```
*Response (200):*
```json
{
"message": "Application successful",
"status": "BID_RECEIVED"
}
```

---

### V. ExÃ©cution de la Course (Trips)

**POST** `/api/trips`
*Request Body (AutomatisÃ© aprÃ¨s validation offre):*
```json
{
"offerId": "uuid-offer",
"driverId": "uuid-driver"
}
```
*Response (201):*
```json
{
"tripId": "uuid-trip",
"status": "CREATED"
}
```

**PATCH** `/api/trips/{id}/status`
*Request Body:*
```json
{
"status": "ONGOING"
}
```
*Response (200):*
```json
{
"tripId": "uuid-trip",
"currentStatus": "ONGOING"
}
```

**POST** `/api/trips/{id}/location`
*Request Body:*
```json
{
"latitude": 3.8485,
"longitude": 11.5021
}
```
*Response (200):*
```json
{ "status": "Location updated" }
```

**GET** `/api/trips/{id}/location`
*Response (200):*
```json
{
"latitude": 3.8485,
"longitude": 11.5021,
"updatedAt": "2025-12-29T10:15:00Z"
}
```

---

## 5. Liste rÃ©capitulative pour le Swagger
Organise tes contrÃ´leurs avec ces tags :
1.  **Auth-Service** : Inscription et Connexion.
2.  **Fare-Calculator** : Estimation du prix.
3.  **Offer-Controller** : CrÃ©ation, listing des offres disponibles, bidding (apply), et sÃ©lection du chauffeur.
4.  **Trip-Controller** : Initialisation du trajet, mise Ã  jour du statut (CREATED/ONGOING/COMPLETED) et tracking GPS.

---

## ðŸ’¡ Suggestions techniques

*   **Mock data** : Pour l'API de coÃ»t, si le service externe rÃ©pond avec une erreur (500), fais en sorte que ton backend renvoie un prix par dÃ©faut (ex: 2000 XAF) pour ne pas bloquer les tests frontend.
*   **Validation Spring** : Utilise `@NotBlank` et `@Size` sur tes DTOs pour valider les JSON de "Register".
*   **React Native** : Utilise un intervalle (setInterval) ou une petite lib de polling pour le `GET /location` afin de simuler le dÃ©placement de la voiture sur la carte du passager.

Bon code Ã  vous deux ! N'hÃ©site pas si tu as besoin d'un script `curl` pour tester une de ces routes.
---

# ðŸ§  Business Rules (Frontend-Oriented)

Cette section dÃ©finit **les rÃ¨gles mÃ©tier immuables** que le frontend doit respecter et faire appliquer via lâ€™API.

---

## 1. RÃ¨gles liÃ©es aux Offres (Offers)

1. **Postulation chauffeur**

* Un chauffeur **ne peut postuler quâ€™une seule fois** Ã  une mÃªme offre.
* Toute tentative multiple doit Ãªtre ignorÃ©e cÃ´tÃ© frontend (dÃ©sactivation du bouton).

2. **Modification du choix chauffeur**

* Une fois un chauffeur sÃ©lectionnÃ© par le client (`DRIVER_SELECTED`),
    **le choix nâ€™est plus modifiable**.
* Le frontend ne doit plus afficher la liste des chauffeurs aprÃ¨s validation.

3. **Expiration dâ€™une offre**

* Une offre **expire automatiquement aprÃ¨s 5 minutes** si aucun chauffeur nâ€™est sÃ©lectionnÃ©.
* Ã‰tat final : `CANCELLED`.
* Le frontend doit afficher un message :
    **Â« Aucune rÃ©ponse reÃ§ue. Lâ€™offre a expirÃ©. Â»**

4. **Annulation dâ€™une offre**

* Lâ€™offre peut Ãªtre annulÃ©e :

    * par le **client**
    * par le **chauffeur sÃ©lectionnÃ©**
* Lâ€™annulation nâ€™est possible **uniquement avant le dÃ©but de la course** (`CREATED`).
* AprÃ¨s dÃ©marrage (`ONGOING`), lâ€™annulation nâ€™est plus permise.

---

## 2. RÃ¨gles liÃ©es aux Courses (Trips)

1. **CrÃ©ation de la course**

* Une course (`Trip`) est crÃ©Ã©e **uniquement aprÃ¨s** :

    * sÃ©lection du chauffeur par le client
    * acceptation implicite du chauffeur
* Ã‰tat initial : `CREATED`.

2. **Paiement**

* **Aucun paiement nâ€™est effectuÃ© via lâ€™application**.
* Le paiement est effectuÃ© **en cash**, **aprÃ¨s la course**, **hors systÃ¨me**.
* Lâ€™Ã©tat `COMPLETED` signifie uniquement :

    * trajet terminÃ©
    * pas une confirmation de paiement Ã©lectronique.

3. **DÃ©marrage de la course**

* Seul le **chauffeur** peut dÃ©clencher le passage Ã  `ONGOING`.
* Le frontend client passe alors en mode **suivi trajet actif**.

4. **Fin de la course**

* Seul le **chauffeur** peut clÃ´turer la course (`COMPLETED`).
* Une fois `COMPLETED`, la course devient **en lecture seule** cÃ´tÃ© frontend.

---

## 3. RÃ¨gles de Tracking GPS

1. **Avant pickup (Approche)**

* Le chauffeur envoie sa position toutes les 5 secondes.
* Le client voit la progression en temps rÃ©el.

2. **Pendant le trajet**

* Le tracking continue jusquâ€™Ã  `COMPLETED`.

3. **ResponsabilitÃ© frontend**

* Le frontend **doit gÃ©rer le polling** (`setInterval`).
* Aucune logique temps rÃ©el (WebSocket) nâ€™est requise Ã  ce stade.

---

# âš ï¸ Gestion des Erreurs (Frontend Contract)

Cette section dÃ©finit **le comportement standard du frontend en cas dâ€™erreur backend**.

---

## 1. ModÃ¨le de rÃ©ponse dâ€™erreur attendu

Le backend renvoie une erreur JSON standardisÃ©e :

```json
{
"timestamp": "2025-12-29T10:30:00Z",
"status": 400,
"error": "Bad Request",
"message": "Offer already expired",
"path": "/api/offers/123/apply"
}
```

---

## 2. Comportement du Frontend

1. **Aucune logique mÃ©tier cÃ´tÃ© frontend**

* Le frontend **ne tente pas dâ€™interprÃ©ter le type dâ€™erreur**.
* Il ne distingue pas `400`, `403`, `409`, etc.

2. **Affichage utilisateur**

* En cas dâ€™erreur backend :

    * afficher un message gÃ©nÃ©rique :

    > **Â« Une erreur est survenue Â»**
    * afficher ensuite le message retournÃ© par le backend :

    > `error.message`

3. **Aucune action automatique**

* Le frontend :

    * ne retry pas automatiquement
    * ne change pas dâ€™Ã©tat local
    * attend une action utilisateur

---

## 3. Exemple de traitement Frontend (Conceptuel)

```ts
try {
await api.call()
} catch (error) {
showToast("Une erreur est survenue")
showToast(error.message)
}
```

*(Exemple conceptuel â€“ non contractuel)*
```

---
### Fichier : `./docs/roadmaps/todo.md`
```md
### ðŸ“‹ Roadmap API RIDE & GO 

- [ ] **TÃ¢che 1 :** Configuration du projet (config,SÃ©curitÃ©, alignement BD Centrale & Seeding,swagger).
- [x] **1.1 : IdentitÃ© & Nettoyage (Metadata)**
    - [x] Mettre Ã  jour le `pom.xml` (artifactId: `ride-and-go`, name: `Ride & Go API`).
    - [x] Renommer le package racine `com.yowyob.rideandgo` en `com.yowyob.rideandgo`.
    - [x] Supprimer tous les fichiers liÃ©s au domaine "Product" (Entities, Mappers, Services, Controllers).
    - [x] Nettoyer `application.yml` (nom de l'app, group-id Kafka, suppression des clÃ©s inutiles).

- [x] **1.2 : Alignement avec la DB Centrale (Structure)**
    - [x] Harmoniser les scripts SQL : Utiliser les noms de tables globaux (`users`, `roles`, `business_actors`) au lieu des prÃ©fixes `ride_and_go_`.
    - [x] Mettre Ã  jour les entitÃ©s Java (`UserEntity`, `RoleEntity`, etc.) avec les bonnes annotations `@Table`.
    - [x] Valider la cohÃ©rence des types UUID pour toutes les clÃ©s primaires et Ã©trangÃ¨res.

- [x] **1.3 : SÃ©curitÃ© RÃ©active & Documentation (Security/Swagger)**
    - [x] ImplÃ©mentation de `SecurityConfig` : Configuration WebFlux rÃ©active (Stateless, protection des routes, dÃ©sactivation du mot de passe par dÃ©faut).
    - [x] Autorisation des routes Swagger et HealthCheck dans la chaÃ®ne de filtres.
    - [x] Organisation du Swagger UI par tags mÃ©tier (Auth, Fares, Offers, Trips) selon les spÃ©cifications.

- [x] **1.4 : Automatisation & Seeding (DonnÃ©es de test)**
    - [x] Configurer `DatabaseInitConfig` pour une exÃ©cution sÃ©quentielle (Schema -> Check -> Data).
    - [x] PrÃ©parer `src/main/resources/local/data.sql` avec les rÃ´les (`PASSENGER`, `DRIVER`) et des utilisateurs de test Ride & Go.
    - [x] **Validation finale** : DÃ©marrage complet de l'application et vÃ©rification des 100+ utilisateurs via Swagger.
- [ ] **TÃ¢che 2 :** Gestion de l'Authentification (auth fake,Liaison TraMaSys & Profils).
- [ ] **TÃ¢che 3 :** Gestion des Offres (Flux Marketplace : Estimation -> Publication -> Bidding -> SÃ©lection).
- [ ] **TÃ¢che 4 :** Gestion des Courses (Cycle de vie : CrÃ©ation -> DÃ©marrage -> Fin).
- [ ] **TÃ¢che 5 :** Gestion du GPS (Moteur de tracking & Polling de position).
- [ ] **TÃ¢che 6 :** Services PÃ©riphÃ©riques & Notation (Calculs rÃ©els, Reviews).
```

---
### Fichier : `./docs/prompts/master_pair_programmer.md`
```md
# ðŸ¤– Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (RÃ©actif)**.
Nous dÃ©veloppons l'API *Ride and go* (Projet TraEnSys).

### ðŸ“‹ Ta MÃ©thode de Travail (IMPÃ‰RATIF)
Pour chaque tÃ¢che demandÃ©e, tu dois obligatoirement suivre ces Ã©tapes :

**Ã‰tape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modÃ¨le de donnÃ©es.
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 2 : Explication du Concept RÃ©actif**
- Avant de coder, explique briÃ¨vement comment le flux rÃ©actif (`Mono`/`Flux`) sera gÃ©rÃ© pour cette tÃ¢che.

**Ã‰tape 3 : ImplÃ©mentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.

**Ã‰tape 4 : Tests & Validation**
- Instructions pour tester via swagger.

### ðŸš« Tes RÃ¨gles de Conduite
1. **ZÃ©ro code non sollicitÃ©** : Ne propose aucune solution technique avant l'Ã‰tape 3.
2. **Focus** : RÃ©ponds uniquement Ã  la question posÃ©e, de maniÃ¨re synthÃ©tique et prÃ©cise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour Ã©viter les erreurs de copier-coller.
4. **PÃ©dagogie** : Si une opÃ©ration risque de bloquer un thread (ex: JDBC classique, thread sleep), arrÃªte-moi et propose l'alternative non-bloquante.

### ðŸ“‚ Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.
 les sepcifications sont dans ke fichier spec.md

 je te fiurnis en entree le cahier de charges du proejt(spec.md) et l'etat actuel du contexte. les servcies a integrer seront pour le moement auth et farecalculator qui viennee nt d'api externes mais le application.yaml pour gerrer des fakedatas quand le service distant est indisponible. par exemple a partir d'une cle mode. commencons par la todo. liste juste les etapges grandes sosu forme de checkboxes

```

---
### Fichier : `./src/test/java/com/yowyob/reactive_hexagonal/ReactiveHexagonalApplicationTests.java`
```java
package com.yowyob.reactive_hexagonal;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ReactiveHexagonalApplicationTests {

	@Test
	void contextLoads() {
	}

}
```

---
### Fichier : `./src/main/resources/local/data.sql`
```sql
-- =====================================================
-- YOWYOB DB - DATA SEEDING SCRIPT
-- PostgreSQL
-- =====================================================


-- =====================================================
-- 1. CLEANUP EXISTING DATA
-- =====================================================
TRUNCATE TABLE 
    users, images, countries, business_actors, 
    admins, fleet_managers, drivers, customers, 
    providers, employees, prospects, sales_persons,
    profiles, settings, addresses, contacts,
    roles, permissions, role_has_permissions,  user_has_permissions,user_has_roles,
    organizations, agencies, business_domains, organization_business_domains,
    certifications, third_parties, proposed_activities, services, branches,
    fleets, vehicles, geofence_zones, geofence_points, geofence_events,
    roads, trips, offers, rides, reviews, offer_driver_linkages,
    operational_parameters, financial_parameters, maintenance_parameters,
    geofence_point_zone_linkages,
    syndicats, abstract_products, products, 
    publications, publication_images, publication_votes, votes,
    events, event_images, reactions, comments, avis,
    subscriptions, payments
    RESTART IDENTITY CASCADE;

-- =====================================================
-- 2. STATIC REFERENCE DATA
-- =====================================================

-- Countries
INSERT INTO countries (name, code) VALUES
('Cameroun', 'CM'), ('SÃ©nÃ©gal', 'SN'), ('CÃ´te d''Ivoire', 'CI'), 
('Gabon', 'GA'), ('NigÃ©ria', 'NG'), ('Togo', 'TG');

-- Roles
INSERT INTO roles (name, guard_name) VALUES
('ADMIN', 'web'), ('FLEET_MANAGER', 'web'), ('DRIVER', 'web'), ('CUSTOMER', 'web');

-- Images (Random placeholders from Picsum)
INSERT INTO images (url, alt_text) 
SELECT 
    'https://picsum.photos/seed/' || i || '/800/600', 
    'Image alÃ©atoire ' || i
FROM generate_series(1, 50) as i;

-- =====================================================
-- 3. USERS GENERATION (100 users)
-- =====================================================

INSERT INTO users (name, phone_number, email_address)
SELECT 
    (ARRAY['Mamadou', 'Jean-Pierre', 'Ibrahim', 'Fatou', 'Aminata', 'Ngolo', 'Aboubakar', 'Clarisse', 'Samuel', 'KouamÃ©', 'Aissatou', 'Bachelard', 'Landry', 'ThÃ©rÃ¨se'])[floor(random()*14)+1] 
    || ' ' || 
    (ARRAY['Diop', 'Njoya', 'Mbarga', 'Kone', 'Sow', 'Etoundi', 'Kamga', 'TraorÃ©', 'Diallo', 'Fofana', 'Mensah', 'Atangana', 'Eto''o', 'Drogba'])[floor(random()*14)+1],
    (ARRAY['+237', '+221', '+225'])[floor(random()*3)+1] || (600000000 + floor(random()*99999999)::int),
    'user_' || i || '@yowyob.test'
FROM generate_series(1, 100) as i;

-- Settings & Profiles
INSERT INTO settings (user_id, theme, language, receive_push_notifications)
SELECT id, 'LIGHT', 'fr', true FROM users;

INSERT INTO profiles (user_id, first_name, nationality, is_verified)
SELECT id, split_part(name, ' ', 1), 'Camerounais', (random() > 0.5) FROM users;

-- =====================================================
-- 4. ACTORS DISPATCHING
-- User -> BusinessActor -> SpecificActor
-- =====================================================

-- 4.1 Admins (First 5 users)
INSERT INTO admins (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5;

-- 4.2 Fleet Managers (Next 5 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- STEP 2: Insert into CHILD (FleetManager)
INSERT INTO fleet_managers (id, name, email_address)
SELECT id, name, email_address FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

-- 4.3 Drivers (Next 30 users)
-- STEP 1: Insert into PARENT (BusinessActor)
INSERT INTO business_actors (id, name, phone_number, email_address)
SELECT id, name, phone_number, email_address FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- STEP 2: Insert into CHILD (Driver)
INSERT INTO drivers (id, status, license_number, has_car)
SELECT 
    id, 
    (ARRAY['AVAILABLE', 'BUSY', 'OFFLINE'])[floor(random()*3)+1], 
    'LIC-' || floor(random()*100000) || '-CM',
    (random() > 0.3)
FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

-- 4.4 Customers (Remaining 60 users)
INSERT INTO customers (id, code, payment_method)
SELECT 
    id, 
    'CUST-' || substr(id::text, 1, 8),
    (ARRAY['CASH', 'MOBILE_MONEY', 'CARD'])[floor(random()*3)+1]
FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- Assign Roles
INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'ADMIN') FROM users ORDER BY email_address LIMIT 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'FLEET_MANAGER') FROM users ORDER BY email_address LIMIT 5 OFFSET 5;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'DRIVER') FROM users ORDER BY email_address LIMIT 30 OFFSET 10;

INSERT INTO user_has_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE name = 'CUSTOMER') FROM users ORDER BY email_address LIMIT 60 OFFSET 40;

-- =====================================================
-- 5. ORGANIZATIONS & AGENCIES
-- =====================================================

INSERT INTO organizations (
    business_actor_id, logo_id, code, short_name, long_name, 
    description, tax_number, is_active, status
)
SELECT
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    (SELECT id FROM images ORDER BY random() LIMIT 1),
    'ORG-' || i,
    'Transport ' || i,
    'SociÃ©tÃ© de Transport ' || i,
    'Description ' || i,
    'TAX-' || floor(random()*1000000),
    true,
    'PUBLISHED'
FROM generate_series(1, 35) as i;

INSERT INTO agencies (
    organization_id, manager_id, name, city, location, is_headquarter
)
SELECT 
    id, 
    (SELECT id FROM fleet_managers ORDER BY random() LIMIT 1),
    'Agence Centrale',
    (ARRAY['Douala', 'YaoundÃ©', 'Abidjan'])[floor(random()*3)+1],
    'Rue Principale',
    true
FROM organizations;

-- =====================================================
-- 6. FLEETS & VEHICLES
-- =====================================================

INSERT INTO fleets (fleet_manager_id, name, phone_number)
SELECT 
    id, 'Flotte de ' || name, '+237699000000'
FROM fleet_managers;

-- Vehicles
INSERT INTO vehicles (
    fleet_id, user_id, driver_id, license_plate, brand, model, type, color, manufacturing_year
)
SELECT 
    f.id,
    f.fleet_manager_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    'LT-' || floor(random()*999)::text || '-AA',
    (ARRAY['Toyota', 'Peugeot'])[floor(random()*2)+1],
    (ARRAY['Yaris', 'Partner'])[floor(random()*2)+1],
    (ARRAY['CAR', 'VAN'])[floor(random()*2)+1]::vehicle_type_enum,
    'Jaune',
    2020
FROM fleets f;

-- =====================================================
-- 7. OFFERS & RIDES
-- =====================================================

INSERT INTO offers (
    passenger_id, start_point, end_point, price, state, created_at
)
SELECT 
    (SELECT id FROM customers ORDER BY random() LIMIT 1),
    'Point A', 'Point B', 
    2000, 
    'CHOSEN',
    NOW()
FROM generate_series(1, 60) as i;

-- Rides
INSERT INTO rides (
    offer_id, passenger_id, driver_id, 
    distance, time_estimation, real_time, state, created_at
)
SELECT 
    id, -- offer_id
    passenger_id,
    (SELECT id FROM drivers ORDER BY random() LIMIT 1),
    15.5, 30, 35,
    'COMPLETED',
    created_at
FROM offers 
LIMIT 40;

-- Reviews
INSERT INTO reviews (ride_id, author_id, subject, comment, rating)
SELECT 
    id,
    passenger_id,
    'Chauffeur',
    'Bonne course, chauffeur ponctuel',
    5
FROM rides
WHERE state = 'COMPLETED';

-- =====================================================
-- 8. PRODUCTS
-- =====================================================

INSERT INTO products (
    organization_id, name, description, standard_price, 
    status, is_active, departure_location
)
SELECT 
    (SELECT id FROM organizations ORDER BY random() LIMIT 1),
    'Trajet SpÃ©cial ' || i,
    'Description produit',
    5000,
    'PUBLISHED',
    true,
    'Douala'
FROM generate_series(1, 40) as i;

-- =====================================================
-- 9. SUBSCRIPTIONS & PAYMENTS
-- =====================================================

INSERT INTO subscriptions (
    admin_id, label, price, duration_in_days, description, is_active
) VALUES 
((SELECT id FROM admins LIMIT 1), 'Pack Hebdo', 2500, 7, 'Standard', true),
((SELECT id FROM admins LIMIT 1), 'Pack Mensuel', 10000, 30, 'Pro', true),
((SELECT id FROM admins LIMIT 1), 'Pack Annuel', 100000, 365, 'VIP', true);

INSERT INTO payments (
    driver_id, user_id, subscription_id, amount_paid, status, id_provider_transaction, created_at
)
SELECT 
    d.id, -- Driver ID
    d.id, -- Payer ID
    s.id, -- Subscription ID
    s.price,
    'SUCCESS',
    'TXN-' || floor(random()*10000000),
    NOW()
FROM drivers d
CROSS JOIN subscriptions s
ORDER BY random()
LIMIT 50;

-- =====================================================
-- 10. SOCIAL & ADDRESSES
-- =====================================================

INSERT INTO syndicats (organization_id, name, is_approved)
SELECT id, 'Syndicat Transports', true FROM organizations LIMIT 1;

INSERT INTO branches (id, syndicat_id, name, location)
SELECT 
    ag.id,
    (SELECT id FROM syndicats LIMIT 1),
    'Branche ' || ag.name, 
    ag.location 
FROM agencies ag 
LIMIT 10;

INSERT INTO publications (branch_id, author_id, content, status, n_likes)
SELECT 
    (SELECT id FROM branches ORDER BY random() LIMIT 1),
    (SELECT id FROM admins ORDER BY random() LIMIT 1),
    'Info Trafic ' || i,
    'PUBLISHED',
    floor(random() * 50)::int
FROM generate_series(1, 40) as i;

-- =====================================================
-- SEEDING DIRECT PERMISSIONS (Test)
-- =====================================================

-- On crÃ©e quelques permissions
INSERT INTO permissions (id, name) VALUES 
(uuid_generate_v4(), 'extra:special_access'),
(uuid_generate_v4(), 'fleet:emergency_stop');

-- On donne la premiÃ¨re permission au premier utilisateur (Admin 1)
INSERT INTO user_has_permissions (user_id, permission_id)
VALUES (
    (SELECT id FROM users ORDER BY email_address LIMIT 1),
    (SELECT id FROM permissions WHERE name = 'extra:special_access' LIMIT 1)
);
```

---
### Fichier : `./src/main/resources/local/schema.sql`
```sql
-- =====================================================
-- YOWYOB DB - INIT SCRIPT
-- PostgreSQL
-- Structure: Core -> Organization -> RBAC
-- =====================================================

-- Clean up existing tables and types to ensure a fresh start
-- We drop them in reverse order of dependency
DROP TABLE IF EXISTS user_has_roles CASCADE;
DROP TABLE IF EXISTS role_has_permissions CASCADE;
DROP TABLE IF EXISTS permissions CASCADE;
DROP TABLE IF EXISTS roles CASCADE;
DROP TABLE IF EXISTS reviews CASCADE;
DROP TABLE IF EXISTS payments CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS admins CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TABLE IF EXISTS comments CASCADE;
DROP TABLE IF EXISTS reactions CASCADE;
DROP TABLE IF EXISTS event_images CASCADE;
DROP TABLE IF EXISTS events CASCADE;
DROP TABLE IF EXISTS publication_images CASCADE;
DROP TABLE IF EXISTS publications CASCADE;
DROP TABLE IF EXISTS branches CASCADE;
DROP TABLE IF EXISTS avis CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS publication_votes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS abstract_products CASCADE;
DROP TABLE IF EXISTS syndicats CASCADE;
DROP TABLE IF EXISTS offer_driver_linkages CASCADE;
DROP TABLE IF EXISTS geofence_events CASCADE;
DROP TABLE IF EXISTS geofence_point_zone_linkages CASCADE;
DROP TABLE IF EXISTS geofence_points CASCADE;
DROP TABLE IF EXISTS maintenance_parameters CASCADE;
DROP TABLE IF EXISTS financial_parameters CASCADE;
DROP TABLE IF EXISTS operational_parameters CASCADE;
DROP TABLE IF EXISTS trips CASCADE;
DROP TABLE IF EXISTS roads CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;
DROP TABLE IF EXISTS geofence_zones CASCADE;
DROP TABLE IF EXISTS fleets CASCADE;
DROP TABLE IF EXISTS fleet_managers CASCADE;
DROP TABLE IF EXISTS rides CASCADE;
DROP TABLE IF EXISTS offers CASCADE;
DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS services CASCADE;
DROP TABLE IF EXISTS customers CASCADE;
DROP TABLE IF EXISTS sales_persons CASCADE;
DROP TABLE IF EXISTS prospects CASCADE;
DROP TABLE IF EXISTS employees CASCADE;
DROP TABLE IF EXISTS providers CASCADE;
DROP TABLE IF EXISTS addresses CASCADE;
DROP TABLE IF EXISTS proposed_activities CASCADE;
DROP TABLE IF EXISTS settings CASCADE;
DROP TABLE IF EXISTS third_parties CASCADE;
DROP TABLE IF EXISTS certifications CASCADE;
DROP TABLE IF EXISTS organization_business_domains CASCADE;
DROP TABLE IF EXISTS contacts CASCADE;
DROP TABLE IF EXISTS business_domains CASCADE;
DROP TABLE IF EXISTS agencies CASCADE;
DROP TABLE IF EXISTS organizations CASCADE;
DROP TABLE IF EXISTS business_actors CASCADE;
DROP TABLE IF EXISTS countries CASCADE;
DROP TABLE IF EXISTS images CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Drop existing types
DROP TYPE IF EXISTS reaction_type_enum CASCADE;
DROP TYPE IF EXISTS type_enum CASCADE;
DROP TYPE IF EXISTS role_type_enum CASCADE;
DROP TYPE IF EXISTS engine_status_enum CASCADE;
DROP TYPE IF EXISTS maintenance_status_enum CASCADE;
DROP TYPE IF EXISTS event_type_enum CASCADE;
DROP TYPE IF EXISTS ride_state_enum CASCADE;
DROP TYPE IF EXISTS offer_state_enum CASCADE;
DROP TYPE IF EXISTS vehicle_type_enum CASCADE;
DROP TYPE IF EXISTS action_enum CASCADE;
DROP TYPE IF EXISTS category_enum CASCADE;
DROP TYPE IF EXISTS status_enum CASCADE;

-- Re-enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";


-- =====================================================
-- ENUM TYPES
-- =====================================================

CREATE TYPE status_enum AS ENUM (
  'DRAFT', 'WAITING_CONFIRMATION', 'PUBLISHED', 'IN_PROGRESS', 'CANCELLED', 'EXPIRED'
);

CREATE TYPE category_enum AS ENUM (
  'ANNOUNCE', 'PLANNING', 'VEHICLE', 'ADDRESS', 'EXPERIENCE'
);

CREATE TYPE action_enum AS ENUM (
  'CREATE', 'UPDATE', 'READ', 'DELETE'
);

CREATE TYPE vehicle_type_enum AS ENUM (
  'CAR', 'VAN', 'TRUCK', 'BIKE'
);

CREATE TYPE offer_state_enum AS ENUM (
  'NEW', 'PENDING', 'CHOSEN', 'TERMINATED', 'CANCELED'
);

CREATE TYPE ride_state_enum AS ENUM (
  'CONFIRMED', 'ONGOING', 'COMPLETED', 'CANCELED'
);

CREATE TYPE event_type_enum AS ENUM (
  'ENTRY', 'EXIT'
);

CREATE TYPE maintenance_status_enum AS ENUM (
  'UP_TO_DATE', 'PENDING', 'OVERDUE'
);

CREATE TYPE engine_status_enum AS ENUM (
  'OK', 'NEED_SERVICE', 'OUT_OF_SERVICE'
);

CREATE TYPE role_type_enum AS ENUM (
  'CUSTOMER', 'DRIVER', 'FLEET_MANAGER', 'ADMIN', 'PASSENGER', 'PRESIDENT', 'MODERATOR', 'CLIENT'
);

CREATE TYPE type_enum AS ENUM (
  'NOTIFICATION', 'CHAT', 'PAYMENT', 'MEDIA'
);

CREATE TYPE reaction_type_enum AS ENUM (
  'LIKE', 'LOVE', 'HAHA', 'WOW', 'SAD', 'ANGRY'
);

-- =====================================================
-- CORE TABLES
-- =====================================================

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  phone_number TEXT,
  email_address TEXT UNIQUE
);

CREATE TABLE images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  url TEXT NOT NULL,
  alt_text TEXT,
  uploaded_at TIMESTAMP DEFAULT now()
);

CREATE TABLE countries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE business_actors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT,
  phone_number TEXT,
  email_address TEXT,
  CONSTRAINT fk_business_actor_user
    FOREIGN KEY (id) REFERENCES users(id)
    ON DELETE CASCADE
);

-- =====================================================
-- ORGANIZATION TABLES
-- =====================================================

CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  business_actor_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  email TEXT,
  short_name TEXT,
  long_name TEXT,
  description TEXT,
  logo_uri TEXT,
  website_url TEXT,
  social_network TEXT,
  business_registration_number TEXT,
  tax_number TEXT,
  capital_share NUMERIC,
  ceo_name TEXT,
  year_founded INT,
  keywords TEXT,
  number_of_employees INT,
  legal_form TEXT,
  is_active BOOLEAN DEFAULT true,
  status status_enum DEFAULT 'DRAFT',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE agencies (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, -- Must belong to an org

  owner_id UUID REFERENCES business_actors(id),
  manager_id UUID REFERENCES business_actors(id),
  logo_id UUID REFERENCES images(id),

  code TEXT,
  name TEXT,
  location TEXT,
  description TEXT,
  transferable BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  logo_uri TEXT,
  short_name TEXT,
  long_name TEXT,
  is_individual_business BOOLEAN DEFAULT false,
  is_headquarter BOOLEAN DEFAULT false,
  country TEXT,
  city TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  open_time TIME,
  close_time TIME,
  phone TEXT,
  email TEXT,
  whatsapp TEXT,
  greeting_message TEXT,
  average_revenue NUMERIC,
  capital_share NUMERIC,
  registration_number TEXT,
  social_network TEXT,
  tax_number TEXT,
  keywords TEXT,
  is_public BOOLEAN DEFAULT false,
  is_business BOOLEAN DEFAULT true,
  total_affiliated_customers INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE business_domains (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL, -- optional link to organization
  parent_id UUID REFERENCES business_domains(id) ON DELETE SET NULL,   -- self-referential for hierarchy
  image_id UUID REFERENCES images(id),

  code TEXT,
  service TEXT,
  name TEXT,
  image_uri TEXT,
  type TEXT,
  type_label TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE organization_business_domains (
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  business_domain_id UUID REFERENCES business_domains(id) ON DELETE CASCADE,
  PRIMARY KEY (organization_id, business_domain_id)
);

CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  contactable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  contactable_type TEXT,
  first_name TEXT,
  last_name TEXT,
  title TEXT,
  is_email_verified BOOLEAN DEFAULT false,
  is_phone_number_verified BOOLEAN DEFAULT false,
  is_favorite BOOLEAN DEFAULT false,
  phone_number TEXT,
  secondary_phone_number TEXT,
  fax_number TEXT,
  email TEXT,
  secondary_email TEXT,
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE certifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  description TEXT,
  obtainment_date DATE,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE third_parties (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  logo_id UUID REFERENCES images(id),

  code TEXT,
  type TEXT,
  legal_form TEXT,
  unique_identification_number TEXT,
  trade_registration_number TEXT,
  name TEXT,
  acronym TEXT,
  long_name TEXT,
  logo_uri TEXT,
  accounting_account_numbers TEXT,
  authorized_payment_methods TEXT,
  authorized_credit_limit NUMERIC,
  max_discount_rate NUMERIC,
  vat_subject BOOLEAN,
  operations_balance NUMERIC,
  opening_balance NUMERIC,
  pay_term_number INT,
  pay_term_type TEXT,
  third_party_family TEXT,
  classification TEXT,
  tax_number TEXT,
  loyalty_points NUMERIC,
  loyalty_points_used NUMERIC,
  loyalty_points_expired NUMERIC,
  enabled BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE settings (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  theme TEXT,
  language TEXT,
  long_ride_enabled BOOLEAN DEFAULT false,
  short_ride_enabled BOOLEAN DEFAULT false,
  privacy_enable BOOLEAN DEFAULT true,
  allow_calls BOOLEAN DEFAULT true,
  allow_messages BOOLEAN DEFAULT true,
  notify_new_rides BOOLEAN DEFAULT true,
  notify_ratings BOOLEAN DEFAULT true,
  notify_practical_tips BOOLEAN DEFAULT true,
  notify_promotions BOOLEAN DEFAULT true,
  notify_policy_updates BOOLEAN DEFAULT true,
  notify_peak_hour_recommendations BOOLEAN DEFAULT true,
  receive_email BOOLEAN DEFAULT true,
  receive_sms BOOLEAN DEFAULT true,
  receive_push_notifications BOOLEAN DEFAULT true,
  receive_whatsapp BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE proposed_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  type TEXT,
  name TEXT,
  rate NUMERIC,
  description TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE addresses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  addressable_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  country_id UUID REFERENCES countries(id) ON DELETE SET NULL,

  addressable_type TEXT,
  type TEXT,
  address_line_1 TEXT,
  address_line_2 TEXT,
  city TEXT,
  state TEXT,
  locality TEXT,
  zip_code TEXT,
  postal_code TEXT,
  po_box TEXT,
  is_default BOOLEAN DEFAULT false,
  neighbor_hood TEXT,
  informal_description TEXT,
  latitude NUMERIC,
  longitude NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

-- =====================================================
-- USERS EXTENDED
-- =====================================================

CREATE TABLE providers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  contact_info TEXT,
  address TEXT,
  is_active BOOLEAN DEFAULT true,
  product_service_type TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE employees (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  is_manager BOOLEAN DEFAULT false,
  role TEXT,
  department TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE prospects (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,
  interest_level TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE sales_persons (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  commission_rate NUMERIC,
  credit NUMERIC,
  current_balance NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE customers (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  code TEXT,
  payment_method TEXT,
  amount_paid NUMERIC,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  deleted_at TIMESTAMP
);

CREATE TABLE services (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

-- =====================================================
-- RIDE & FLEET MANAGEMENT
-- =====================================================

CREATE TABLE drivers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  status TEXT,
  license_number TEXT,
  has_car BOOLEAN DEFAULT false
);

CREATE TABLE offers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  passenger_id UUID REFERENCES customers(id) ON DELETE CASCADE,

  start_point TEXT,
  end_point TEXT,
  price NUMERIC,
  state offer_state_enum DEFAULT 'NEW',
  ids_interested_drivers TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE rides (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  offer_id UUID REFERENCES offers(id) ON DELETE SET NULL,
  passenger_id UUID REFERENCES users(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  distance NUMERIC,
  time_estimation NUMERIC,
  real_time NUMERIC,
  state ride_state_enum DEFAULT 'CONFIRMED',

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE fleet_managers (
  id UUID PRIMARY KEY REFERENCES business_actors(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE fleets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  fleet_manager_id UUID REFERENCES fleet_managers(id) ON DELETE SET NULL,

  name TEXT,
  phone_number TEXT,
  email_address TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE geofence_zones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  surface_area NUMERIC,
  perimeter NUMERIC
);

CREATE TABLE vehicles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  fleet_id UUID REFERENCES fleets(id) ON DELETE SET NULL,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,

  license_plate TEXT,
  model TEXT,
  brand TEXT,
  manufacturing_year INT,
  type vehicle_type_enum,
  color TEXT
);

CREATE TABLE roads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  start_point TEXT,
  end_point TEXT
);

CREATE TABLE trips (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  road_id UUID REFERENCES roads(id) ON DELETE SET NULL,
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,

  start_date DATE,
  end_date DATE,
  start_time TIME,
  end_time TIME,
  type TEXT,
  color TEXT
);

CREATE TABLE operational_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  statut TEXT,
  current_location TEXT,
  current_speed NUMERIC,
  fuel_level NUMERIC,
  mileage NUMERIC,
  odometer_reading NUMERIC,
  bearing NUMERIC,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE financial_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  insurance_number TEXT,
  insurance_expired_at DATE,
  registered_at DATE,
  purchased_at DATE,
  depreciation_rate NUMERIC,
  cost_per_km NUMERIC
);

CREATE TABLE maintenance_parameters (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  trip_id UUID REFERENCES trips(id) ON DELETE CASCADE,

  last_maintenance_at DATE,
  next_maintenance_at DATE,
  engine_status engine_status_enum DEFAULT 'OK',
  battery_health TEXT,
  maintenance_status maintenance_status_enum DEFAULT 'UP_TO_DATE'
);

CREATE TABLE geofence_points (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  latitude NUMERIC,
  longitude NUMERIC
);

CREATE TABLE geofence_point_zone_linkages (
  point_id UUID REFERENCES geofence_points(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE CASCADE,
  PRIMARY KEY (point_id, zone_id)
);

CREATE TABLE geofence_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  vehicle_id UUID REFERENCES vehicles(id) ON DELETE CASCADE,
  zone_id UUID REFERENCES geofence_zones(id) ON DELETE SET NULL,
  point_id UUID REFERENCES geofence_points(id) ON DELETE SET NULL,

  type event_type_enum,

  timestamp TIMESTAMP DEFAULT now()
);

CREATE TABLE offer_driver_linkages (
  offer_id UUID REFERENCES offers(id) ON DELETE CASCADE,
  driver_id UUID REFERENCES drivers(id) ON DELETE CASCADE,
  PRIMARY KEY (offer_id, driver_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- OTHERS: PRODUCTS, SYNDICATS, PUBLICATIONS & REVIEWS
-- =====================================================

CREATE TABLE syndicats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,

  is_approved BOOLEAN DEFAULT false,
  name TEXT,
  description TEXT,
  domain TEXT,
  type TEXT,
  charte_url TEXT,
  status_url TEXT,
  members_list_url TEXT,
  commitment_certificate_url TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE abstract_products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  abstract_product_id UUID REFERENCES abstract_products(id) ON DELETE SET NULL,

  name TEXT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  standard_price NUMERIC,
  departure_location TEXT,
  arrival_location TEXT,
  start_date DATE,
  start_time TIME,
  end_date DATE,
  end_time TIME,
  baggage_info TEXT,
  is_negotiable BOOLEAN DEFAULT false,
  payment_method TEXT,
  title TEXT,
  status status_enum DEFAULT 'DRAFT',
  product_urls TEXT,
  regular_amount NUMERIC,
  discount_percentage NUMERIC,
  discounted_amount NUMERIC,
  metadata JSONB,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  title TEXT,
  description TEXT,
  closing_at TIMESTAMP,
  type category_enum
);

CREATE TABLE votes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  publication_vote_id UUID REFERENCES publication_votes(id) ON DELETE CASCADE,

  label TEXT
);

CREATE TABLE avis (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id) ON DELETE CASCADE,
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  comment TEXT,
  number INT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE branches (
  id UUID PRIMARY KEY REFERENCES agencies(id),
  syndicat_id UUID REFERENCES syndicats(id) ON DELETE SET NULL,

  name TEXT,
  location TEXT,
  contact TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  content TEXT,
  status status_enum DEFAULT 'DRAFT',
  n_likes INT DEFAULT 0,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE publication_images (
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (publication_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  branch_id UUID REFERENCES branches(id) ON DELETE SET NULL,

  title TEXT,
  description TEXT,
  location TEXT,
  date DATE,
  start_time TIME,
  end_time TIME,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE event_images (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  image_id UUID REFERENCES images(id) ON DELETE CASCADE,
  PRIMARY KEY (event_id, image_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  type reaction_type_enum,

  reacted_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,
  publication_id UUID REFERENCES publications(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES comments(id) ON DELETE SET NULL,
  image_id UUID REFERENCES images(id) ON DELETE SET NULL,

  content TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  first_name TEXT,
  last_name TEXT,
  nickname TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  nationality TEXT,
  gender TEXT,
  language TEXT,
  company_name TEXT,
  biography TEXT,
  rating NUMERIC,
  total_trips INT,
  is_available BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- PAYMENTS & SUBSCRIPTIONS
-- =====================================================

CREATE TABLE admins (
  id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,

  name TEXT,
  phone_number TEXT,
  email_address TEXT
);

CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  admin_id UUID REFERENCES admins(id) ON DELETE SET NULL,

  label TEXT,
  price NUMERIC,
  duration_in_days INT,
  description TEXT,
  is_active BOOLEAN DEFAULT true,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  driver_id UUID REFERENCES drivers(id) ON DELETE SET NULL,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  user_id UUID REFERENCES business_actors(id) ON DELETE SET NULL,

  amount_paid NUMERIC,
  status TEXT,
  id_provider_transaction TEXT,

  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ride_id UUID REFERENCES rides(id) ON DELETE CASCADE,
  author_id UUID REFERENCES users(id) ON DELETE SET NULL,

  subject TEXT,
  comment TEXT,
  rating NUMERIC,

  created_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- ROLE-BASED ACCESS CONTROL (RBAC)
-- =====================================================

CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  name TEXT NOT NULL,
  guard_name TEXT,

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE role_has_permissions (
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE user_has_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id UUID REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- =====================================================
-- FIX: DIRECT PERMISSIONS (USER <-> PERMISSIONS)
-- =====================================================

-- Table de liaison pour les permissions accordÃ©es directement Ã  un utilisateur
CREATE TABLE IF NOT EXISTS user_has_permissions (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  permission_id UUID REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, permission_id),

  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

-- Commit the transaction


-- =====================================================
-- END OF SCRIPT. NOTHING AFTER HERE!
-- =====================================================
```

---
### Fichier : `./src/main/resources/application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: ride-and-go
  profiles:
    active: local
  docker:
    compose:
      enabled: false

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:127.0.0.1}:${DB_PORT:5432}/${DB_NAME:yowyob_db}
    username: ${DB_USERNAME:fleet_admin}
    password: ${DB_PASSWORD:fleet_password}
    pool:
      enabled: true
      initial-size: 1
      max-size: 5
      max-idle-time: 30m
      max-life-time: 10m
      acquire-retry: 3
      max-acquire-time: 30s
      validation-query: SELECT 1
  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:7000}
      password: ${REDIS_PASSWORD:password}
      cluster:
        enabled: false

  # KAFKA 
  kafka:
    bootstrap-servers: ${KAFKA_HOST:localhost}:${KAFKA_PORT:9092}
    consumer:
      group-id: ride-and-go-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    fare-calculator-url: https://fare-calculator-service.pynfi.com

  kafka:
    topics:
      notification-service-create-topic: notification-create-topic
      offer-created: offer-created-topic
      offer-send: notification-send-topic
    notification-registration:
      name: "Ride and Go"
      email:
        host: ${SMTP_HOST:smtp.gmail.com}
        port: ${SMTP_PORT:587}
        username: ${SMTP_USERNAME}
        password: ${SMTP_PASSWORD}
    notification-service:
      token: token-topic
      template:
        new-offer-id: 1001
        accepted-offer-id: 1002

management:
  endpoints:
    web:
      exposure:
        include: ["health","info","prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5
      fare-calculator-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5
```

---
### Fichier : `./src/main/resources/prod.application.yml`
```yaml
# ===================================================================
# PRODUCTION CONFIGURATION - RIDE & GO API
# ===================================================================

server:
  port: 8080
  error:
    include-message: always # Useful for frontend debugging

spring:
  application:
    name: ride-and-go

  # DATABASE CONFIGURATION (REACTIVE R2DBC)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:168.119.122.86}:${DB_PORT:5432}/${DB_NAME:yowyob}
    username: ${DB_USERNAME:master}
    password: ${DB_PASSWORD:Azerty1234*}
    pool:
      enabled: true
      initial-size: 5
      max-size: 20
      max-idle-time: 30m
      validation-query: SELECT 1

  # CRITICAL SECURITY: Never run local scripts on production server
  sql:
    init:
      mode: never

  # REDIS CACHE (CLUSTER MODE)
  data:
    redis:
      password: ${REDIS_PASSWORD:Azerty1234*}
      cluster:
        nodes:
          - ${REDIS_HOST:168.119.122.86}:7001
          - ${REDIS_HOST:168.119.122.86}:7002
          - ${REDIS_HOST:168.119.122.86}:7003

  # MESSAGING SYSTEM (KAFKA)
  kafka:
    bootstrap-servers: ${KAFKA_HOST:168.119.122.86}:${KAFKA_PORT:9092}
    consumer:
      group-id: ride-and-go-group
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM BUSINESS SERVICES CONFIGURATION
application:
  external:
    # URL of the Fleet & Vehicle technical service
    vehicle-service-url: https://vehicule-service.pynfi.com
    # URL of the Fare calculation engine
    fare-calculator-url: https://fare-calculator-service.pynfi.com
    
  auth:
    mode: remote # Switch to real TraMaSys authentication
    url: https://auth-service.pynfi.com

  kafka:
    topics:
      offer-created: offer-created-topic
      notification-service-create-topic: notification-create-topic

# MONITORING & HEALTH CHECK (ACTUATOR)
management:
  endpoints:
    web:
      exposure:
        include: ["health", "info", "prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# RESILIENCE CONFIGURATION (CIRCUIT BREAKERS)
resilience4j:
  circuitbreaker:
    instances:
      fare-calculator-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        slidingWindowSize: 10
      auth-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/RideAndGoApplication.java`
```java
package com.yowyob.rideandgo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class RideAndGoApplication {

	public static void main(String[] args) {
		SpringApplication.run(RideAndGoApplication.class, args);
	}

}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/mappers/RoleMapper.java`
```java
package com.yowyob.rideandgo.infrastructure.mappers;

import com.yowyob.rideandgo.domain.model.Role;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.RoleEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface RoleMapper {

    @Mapping(target = "permissions", ignore = true)
    Role toDomain(RoleEntity entity);

    @Mapping(target = "createdBy", ignore = true)
    @Mapping(target = "createdDate", ignore = true)
    @Mapping(target = "lastModifiedBy", ignore = true)
    @Mapping(target = "lastModifiedDate", ignore = true)
    @Mapping(target = "version", ignore = true)
    RoleEntity toEntity(Role domain);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/mappers/RideMapper.java`
```java
package com.yowyob.rideandgo.infrastructure.mappers;

import com.yowyob.rideandgo.domain.model.Ride;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.RideResponse;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.RideEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

@Mapper(componentModel = "spring")
public interface RideMapper {
    Ride toDomain(RideEntity entity);

    @Mapping(target = "createdBy", ignore = true)
    @Mapping(target = "createdDate", ignore = true)
    @Mapping(target = "lastModifiedBy", ignore = true)
    @Mapping(target = "lastModifiedDate", ignore = true)
    @Mapping(target = "version", ignore = true)
    RideEntity toEntity(Ride domain);

    RideResponse toResponse(Ride domain);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/mappers/UserMapper.java`
```java
package com.yowyob.rideandgo.infrastructure.mappers;

import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.CreateUserRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.UserResponse;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.UserEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserMapper {

    /**
     * Maps database entity to domain model.
     * Roles and permissions are handled manually in the Persistence Adapter.
     */
    @Mapping(target = "roles", ignore = true)
    @Mapping(target = "directPermissions", ignore = true)
    User toDomain(UserEntity entity);

    /**
     * Maps domain model to database entity.
     * Join tables are handled separately in the persistence layer.
     */
    UserEntity toEntity(User domain);

    /**
     * Maps registration request to domain model.
     */
    @Mapping(target = "roles", ignore = true)
    @Mapping(target = "directPermissions", ignore = true)
    User toDomain(CreateUserRequest request);

    /**
     * Maps domain model to API response.
     * The specific RoleType is manually set in the Controller.
     */
    @Mapping(target = "role", ignore = true)
    UserResponse toResponse(User domain);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/mappers/FareMapper.java`
```java
package com.yowyob.rideandgo.infrastructure.mappers;

import com.yowyob.rideandgo.domain.model.Fare;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareResponse;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface FareMapper {

    /**
     * Maps API response to domain model.
     */
    @Mapping(target = "startPoint", source = "startLocationName")
    @Mapping(target = "endPoint", source = "endLocationName")
    @Mapping(target = "userId", ignore = true)
    Fare toDomain(FareResponse response);

    /**
     * Maps domain model to API response for the frontend.
     */
    @Mapping(target = "startLocationName", source = "domain.startPoint")
    @Mapping(target = "endLocationName", source = "domain.endPoint")
    @Mapping(target = "cached", source = "isCached")
    FareResponse toResponse(Fare domain, boolean isCached);

    /**
     * Maps initial request to domain model.
     */
    @Mapping(target = "startPoint", source = "startLocationName")
    @Mapping(target = "endPoint", source = "endLocationName")
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "userId", ignore = true)
    @Mapping(target = "estimatedFare", ignore = true)
    @Mapping(target = "officialFare", ignore = true)
    Fare toDomain(FareRequest request);
}   ```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/mappers/OfferMapper.java`
```java
package com.yowyob.rideandgo.infrastructure.mappers;

import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.CreateOfferRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.OfferResponse;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferAgreementEntity;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import java.util.*;
import java.util.stream.Collectors;

@Mapper(componentModel = "spring")
public interface OfferMapper {

    @Mapping(source = "agreements", target = "interestedDrivers")
    Offer toDomain(OfferEntity entity);

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "interestedDrivers", ignore = true)
    @Mapping(target = "version", ignore = true)
    Offer toDomain(CreateOfferRequest request);

    OfferResponse toResponse(Offer domain);

    // Fix: We ignore 'agreements' here because the persistence adapter 
    // handles the saving of links in the 'offer_driver_linkages' table separately.
    @Mapping(target = "agreements", ignore = true) 
    @Mapping(target = "createdBy", ignore = true)
    @Mapping(target = "createdDate", ignore = true)
    @Mapping(target = "lastModifiedBy", ignore = true)
    @Mapping(target = "lastModifiedDate", ignore = true)
    OfferEntity toEntity(Offer domain);

    /**
     * Helper to map list of entities to list of UUIDs (Entity -> Domain)
     */
    default List<UUID> mapAgreementsToDriversIds(List<OfferAgreementEntity> agreements) {
        if (agreements == null || agreements.isEmpty()) {
            return Collections.emptyList();
        }
        return agreements.stream()
                .map(OfferAgreementEntity::getDriverId)
                .collect(Collectors.toList());
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/external/FareAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.external;

import com.yowyob.rideandgo.application.utils.Utils;
import com.yowyob.rideandgo.domain.ports.out.FareClientPort;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareResponse;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.external.client.FareCalculatorClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreaker;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreakerFactory;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

import java.util.concurrent.ThreadLocalRandom;

@Component
@Slf4j
@RequiredArgsConstructor
public class FareAdapter implements FareClientPort {
    private final FareCalculatorClient client;
    private final ReactiveCircuitBreakerFactory<?, ?> cbFactory;

    @Override
    public Mono<FareResponse> caclculateFare(FareRequest request) {
        ReactiveCircuitBreaker rcb = cbFactory.create("fare-calculator-service");

        return rcb.run(
                client.calculateFare(request),
                throwable -> fallbackFareCheck(request, throwable)
        );
    }

    private Mono<FareResponse> fallbackFareCheck(FareRequest request, Throwable throwable) {
        log.warn("Circuit Breaker open or Service Down for {}. Error: {}", request, throwable.getMessage());

        return Mono.just(createRandomFareResponse());
    }

    private FareResponse createRandomFareResponse() {
        ThreadLocalRandom random = ThreadLocalRandom.current();
        int distance = random.nextInt(1_000, 50_001);
        int duration = random.nextInt(300, 3_601);
        String currency = "EUR";
        String fareId = Utils.generateUUID().toString();
        boolean success = true;

        return new FareResponse(distance, duration, currency, fareId, success);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/external/client/FareCalculatorClient.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.external.client;


import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareResponse;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.service.annotation.HttpExchange;
import org.springframework.web.service.annotation.PostExchange;
import reactor.core.publisher.Mono;

@HttpExchange("/api/v2")
public interface FareCalculatorClient {
    @PostExchange("/fares/calculate")
    Mono<FareResponse> calculateFare(@RequestBody FareRequest request);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/messaging/SendNotificationAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.messaging;

import com.yowyob.rideandgo.application.utils.Constants;
import com.yowyob.rideandgo.domain.ports.out.SendNotificationPort;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.SendNotificationRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

@Slf4j
@Component
@RequiredArgsConstructor
public class SendNotificationAdapter implements SendNotificationPort {

    private final KafkaTemplate<String, SendNotificationRequest> kafkaTemplate;

    @Value("${application.kafka.notification-service.token}")
    private String token;

    @Value("${application.kafka.topics.notification-service-create-topic}")
    private String topic;

    @Override
    public Mono<Boolean> sendNotification(SendNotificationRequest request) {
        ProducerRecord<String, SendNotificationRequest> record = new ProducerRecord<>(topic, request);
        record.headers().add(Constants.NOTIFICATION_SERVICE_TOKEN_HEADER, token.getBytes());

        return Mono.fromFuture(kafkaTemplate.send(record))
                .thenReturn(true)
                .onErrorReturn(false);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/messaging/OfferEventPublisherAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.messaging;

import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.domain.ports.out.OfferEventPublisherPort;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

@Slf4j
@Component
@RequiredArgsConstructor
public class OfferEventPublisherAdapter implements OfferEventPublisherPort {

    private final KafkaTemplate<String, Offer> kafkaTemplate;

    @Value("${application.kafka.topics.offer-created}")
    private String topic;

    @Override
    public Mono<Void> publishOfferCreatedEvent(Offer offer) {
        return Mono.fromFuture(kafkaTemplate.send(topic, offer.id().toString(), offer))
                .then();
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/PermissionEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import java.util.UUID;

@Data @EqualsAndHashCode(callSuper = true)
@NoArgsConstructor @AllArgsConstructor
@Table("permissions")
public class PermissionEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;
    private String name;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/OfferAgreementEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@EqualsAndHashCode(callSuper = true)
@Data 
@NoArgsConstructor
@AllArgsConstructor
@Table("offer_driver_linkages") 
public class OfferAgreementEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;

    @Column("driver_id")
    private UUID driverId;

    @Column("offer_id")
    private UUID offerId;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/OfferEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import com.yowyob.rideandgo.domain.model.enums.OfferState;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.List;
import java.util.UUID;

@EqualsAndHashCode(callSuper = true)
@Data 
@NoArgsConstructor 
@AllArgsConstructor
@Table("offers") 
public class OfferEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;

    @Column("passenger_id")
    private UUID passengerId;

    @Column("start_point")
    private String startPoint;

    @Column("end_point")
    private String endPoint;

    private double price;

    private OfferState state;

    @Transient
    private List<OfferAgreementEntity> agreements;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/AbstractAuditingEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import lombok.*;
import org.springframework.data.annotation.*;
import org.springframework.data.relational.core.mapping.Column;

import java.io.Serializable;
import java.time.LocalDateTime;

@Getter @Setter
public abstract class AbstractAuditingEntity implements Serializable {
    @CreatedBy
    @Column("created_by")
    private String createdBy;

    @CreatedDate
    @Column("created_date")
    private LocalDateTime createdDate;

    @LastModifiedBy
    @Column("last_modified_by")
    private String lastModifiedBy;

    @LastModifiedDate
    @Column("last_modified_date")
    private LocalDateTime lastModifiedDate;

    @Version
    private Long version;
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/UserEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data 
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor 
@AllArgsConstructor
@Table("users") 
public class UserEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;

    private String name;
    
    @Column("email_address") 
    private String email;

    @Column("phone_number") 
    private String telephone;

    private String password;


}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/RideEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import com.yowyob.rideandgo.domain.model.enums.RideState;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
@Table("rides")
public class RideEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;

    @Column("offer_id")
    private UUID offerId;

    @Column("driver_id")
    private UUID driverId;

    @Column("passenger_id")
    private UUID passengerId;

    private double distance;

    private int duration;

    private RideState state;

    @Column("real_time") 
    private int timeReal;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/entity/RoleEntity.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity;

import com.yowyob.rideandgo.domain.model.enums.RoleType;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data 
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor 
@AllArgsConstructor
@Table("roles")
public class RoleEntity extends AbstractAuditingEntity {
    @Id
    private UUID id;

    private RoleType type;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/RoleR2dbcAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence;

import com.yowyob.rideandgo.domain.model.Role;
import com.yowyob.rideandgo.domain.model.Permission;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.domain.ports.out.RoleRepositoryPort;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.RoleEntity;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.PermissionR2dbcRepository;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.RoleR2dbcRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

import java.util.UUID;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class RoleR2dbcAdapter implements RoleRepositoryPort {

    private final RoleR2dbcRepository roleRepository;
    private final PermissionR2dbcRepository permissionRepository;

    @Override
    public Mono<Role> findByRoleName(RoleType type) {
        return roleRepository.findByType(type)
                .flatMap(this::enrichRole);
    }

    @Override
    public Mono<Role> findRoleById(UUID roleId) {
        return roleRepository.findById(roleId)
                .flatMap(this::enrichRole);
    }

    /**
     * Hydrates a RoleEntity with its associated Permissions.
     */
    private Mono<Role> enrichRole(RoleEntity entity) {
        return permissionRepository.findAllByRoleId(entity.getId())
                .map(p -> new Permission(p.getId(), p.getName()))
                .collect(Collectors.toSet())
                .map(perms -> Role.builder()
                        .id(entity.getId())
                        .type(entity.getType())
                        .permissions(perms)
                        .build());
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/RideR2dbcAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence;

import com.yowyob.rideandgo.domain.model.Ride;
import com.yowyob.rideandgo.domain.ports.out.RideRepositoryPort;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.RideR2dbcRepository;
import com.yowyob.rideandgo.infrastructure.mappers.RideMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class RideR2dbcAdapter implements RideRepositoryPort {
    private final RideR2dbcRepository repository;
    private final RideMapper mapper;

    @Override
    public Mono<Ride> save(Ride ride) {
        return repository.save(mapper.toEntity(ride))
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Ride> findRideById(UUID id) {
        return repository.findById(id)
                .map(mapper::toDomain);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/OfferAgreementR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferAgreementEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface OfferAgreementR2dbcRepository extends ReactiveCrudRepository<OfferAgreementEntity, UUID> {
    Mono<OfferAgreementEntity> findByOfferIdAndDriverId(UUID offerId, UUID driverId);

    Flux<OfferAgreementEntity> findByOfferId(UUID offerId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/RideR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.RideEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;

import java.util.UUID;

public interface RideR2dbcRepository extends ReactiveCrudRepository<RideEntity, UUID> {
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/RoleR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.RoleEntity;
import org.springframework.data.r2dbc.repository.Query;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface RoleR2dbcRepository extends ReactiveCrudRepository<RoleEntity, UUID> {
    
    /**
     * Finds a role entity by its business type (Enum).
     */
    Mono<RoleEntity> findByType(RoleType type);

    /**
     * Finds all roles associated with a user through the join table.
     */
    @Query("SELECT r.* FROM roles r JOIN user_has_roles uhr ON r.id = uhr.role_id WHERE uhr.user_id = :userId")
    Flux<RoleEntity> findAllByUserId(UUID userId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/OfferR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;

import java.util.UUID;

public interface OfferR2dbcRepository extends ReactiveCrudRepository<OfferEntity, UUID> {
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/UserR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.UserEntity;
import org.springframework.data.r2dbc.repository.Query;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import reactor.core.publisher.Flux;

import java.util.UUID;

public interface UserR2dbcRepository extends ReactiveCrudRepository<UserEntity, UUID> {

    /**
     * Finds all users associated with a specific role ID using the join table.
     */
    @Query("SELECT u.* FROM users u JOIN user_has_roles uhr ON u.id = uhr.user_id WHERE uhr.role_id = :roleId")
    Flux<UserEntity> findAllByRoleId(UUID roleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/repository/PermissionR2dbcRepository.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.PermissionEntity;
import org.springframework.data.r2dbc.repository.Query;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import reactor.core.publisher.Flux;
import java.util.UUID;

public interface PermissionR2dbcRepository extends ReactiveCrudRepository<PermissionEntity, UUID> {
    
    @Query("SELECT p.* FROM permissions p JOIN role_has_permissions rhp ON p.id = rhp.permission_id WHERE rhp.role_id = :roleId")
    Flux<PermissionEntity> findAllByRoleId(UUID roleId);

    @Query("SELECT p.* FROM permissions p JOIN user_has_permissions uhp ON p.id = uhp.permission_id WHERE uhp.user_id = :userId")
    Flux<PermissionEntity> findDirectPermissionsByUserId(UUID userId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/UserR2dbcAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence;

import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.Role;
import com.yowyob.rideandgo.domain.model.Permission;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.domain.ports.out.UserRepositoryPort;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.UserEntity;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.*;
import com.yowyob.rideandgo.infrastructure.mappers.UserMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class UserR2dbcAdapter implements UserRepositoryPort {

    private final UserR2dbcRepository userRepository;
    private final RoleR2dbcRepository roleRepository;
    private final PermissionR2dbcRepository permissionRepository;
    private final UserMapper userMapper;

    @Override
    public Mono<User> findUserById(UUID userId) {
        return userRepository.findById(userId)
                .flatMap(this::enrichUser);
    }

  

    @Override
    public Flux<User> findAll() {
        return userRepository.findAll()
                .flatMap(this::enrichUser);
    }

    @Override
    public Flux<User> findByRoleName(RoleType type) {
        return roleRepository.findByType(type)
                .flatMapMany(role -> userRepository.findAllByRoleId(role.getId()))
                .flatMap(this::enrichUser);
    }

    @Override
    public Mono<User> save(User user) {
        UserEntity entity = userMapper.toEntity(user);
        return userRepository.save(entity)
                .map(saved -> user); 
    }

    @Override
    public Mono<Boolean> delete(User user) {
        return userRepository.deleteById(user.id()).thenReturn(true).onErrorReturn(false);
    }

    @Override
    public Mono<Boolean> deleteById(UUID userId) {
        return userRepository.deleteById(userId).thenReturn(true).onErrorReturn(false);
    }

    @Override
    public Mono<Boolean> exists(User user) {
        return userRepository.existsById(user.id());
    }

    /**
     * Aggregates Roles and Permissions into a complete Domain User object.
     * Uses parallel fetching to optimize performance.
     */
    private Mono<User> enrichUser(UserEntity entity) {
        // Fetch Roles and their specific permissions
        Mono<Set<Role>> rolesMono = roleRepository.findAllByUserId(entity.getId())
                .flatMap(roleEntity -> 
                    permissionRepository.findAllByRoleId(roleEntity.getId())
                        .map(p -> new Permission(p.getId(), p.getName()))
                        .collect(Collectors.toSet())
                        .map(perms -> Role.builder()
                                .id(roleEntity.getId())
                                .type(roleEntity.getType())
                                .permissions(perms)
                                .build())
                ).collect(Collectors.toSet());

        // Fetch permissions assigned directly to the user
        Mono<Set<Permission>> directPermsMono = permissionRepository.findDirectPermissionsByUserId(entity.getId())
                .map(p -> new Permission(p.getId(), p.getName()))
                .collect(Collectors.toSet());

        // Combine all reactive streams
        return Mono.zip(rolesMono, directPermsMono)
                .map(tuple -> User.builder()
                        .id(entity.getId())
                        .name(entity.getName())
                        .email(entity.getEmail())
                        .telephone(entity.getTelephone())
                        .roles(tuple.getT1())
                        .directPermissions(tuple.getT2())
                        .build());
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/persistence/OfferR2dbcAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence;

import com.yowyob.rideandgo.application.utils.Utils;
import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.domain.ports.out.OfferRepositoryPort;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferAgreementEntity;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.entity.OfferEntity;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.OfferAgreementR2dbcRepository;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.persistence.repository.OfferR2dbcRepository;
import com.yowyob.rideandgo.infrastructure.mappers.OfferMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;

@Slf4j
@Component
@RequiredArgsConstructor
public class OfferR2dbcAdapter implements OfferRepositoryPort {

    private final OfferAgreementR2dbcRepository offerAgreementRepository;
    private final OfferR2dbcRepository offerRepository;
    private final OfferMapper offerMapper;

    @Override
    @Transactional
    public Mono<Offer> save(Offer offer) {
        log.info("Saving offer: {}", offer);
        OfferEntity entity = offerMapper.toEntity(offer);

        return offerRepository.save(entity)
                .flatMap(savedOfferEntity -> {
                    if (offer.interestedDrivers() == null || offer.interestedDrivers().isEmpty()) {
                        return Mono.just(savedOfferEntity);
                    }

                    return Flux.fromIterable(offer.interestedDrivers())
                            .flatMap(driverId -> offerAgreementRepository
                                    .findByOfferIdAndDriverId(savedOfferEntity.getId(), driverId)
                                    .switchIfEmpty(Mono.defer(() -> {
                                        OfferAgreementEntity newAgreement = new OfferAgreementEntity(
                                                Utils.generateUUID(),
                                                driverId,
                                                savedOfferEntity.getId()
                                        );
                                        return offerAgreementRepository.save(newAgreement);
                                    })))
                            .collectList()
                            .map(agreements -> {
                                savedOfferEntity.setAgreements(agreements);
                                return savedOfferEntity;
                            });
                })
                .map(offerMapper::toDomain);
    }

    @Override
    public Mono<Boolean> delete(Offer offer) {
        return offerRepository.delete(offerMapper.toEntity(offer))
                .thenReturn(true)
                .onErrorReturn(false);
    }

    @Override
    public Mono<Boolean> exists(Offer offer) {
        return offerRepository.existsById(offer.id());
    }

    @Override
    public Mono<Offer> findById(UUID offerId) {
        return offerRepository.findById(offerId)
                .flatMap(entity -> {
                    return offerAgreementRepository.findByOfferId(offerId)
                            .collectList()
                            .map(agreements -> {
                                entity.setAgreements(agreements);
                                return entity;
                            });
                })
                .map(offerMapper::toDomain);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/outbound/cache/RedisAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.outbound.cache;

import com.yowyob.rideandgo.domain.model.Fare;
import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.ports.out.FareCachePort;
import com.yowyob.rideandgo.domain.ports.out.OfferCachePort;

import com.yowyob.rideandgo.domain.ports.out.UserCachePort;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;
import java.time.Duration;
import java.util.UUID;

@Slf4j
@Component
@RequiredArgsConstructor
public class RedisAdapter implements  OfferCachePort, UserCachePort, FareCachePort {
    private final ReactiveRedisTemplate<String, Object> redisTemplate;

 

    @Override
    public Mono<Boolean> saveInCache(Offer offer) {
        return redisTemplate.opsForValue()
                .set("offer:"+ offer.id(), offer, Duration.ofMinutes(15));
    }

    @Override
    public Mono<Offer> findOfferById(UUID offerId) {
        log.info("findOfferById: {}", offerId);
        return redisTemplate.opsForValue()
                .get("offer:" + offerId)
                .cast(Offer.class)
                .onErrorResume(e -> Mono.empty());
    }

    @Override
    public Mono<Boolean> saveInCache(User user) {
        return redisTemplate.opsForValue()
                .set("user:" + user.id(), user, Duration.ofMinutes(10));
    }

    @Override
    public Mono<User> findUserById(UUID userId) {
        return redisTemplate.opsForValue()
                .get("user:" + userId)
                .cast(User.class);
    }

    @Override
    public Mono<Boolean> saveInCache(Fare fare) {
        return redisTemplate.opsForValue()
                .set("fare:" + fare.id(), fare, Duration.ofMinutes(10));
    }

    @Override
    public Mono<Fare> findFareById(UUID fareId) {
        return redisTemplate.opsForValue()
                .get("fare:" + fareId)
                .cast(Fare.class);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/kafka/kafkaAdapter.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.kafka;

public class kafkaAdapter {
    
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/FareController.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest;

import com.yowyob.rideandgo.domain.ports.in.PutFareInCacheUseCase;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareResponse;
import com.yowyob.rideandgo.infrastructure.adapters.outbound.external.client.FareCalculatorClient;
import com.yowyob.rideandgo.infrastructure.mappers.FareMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/fares")
@Tag(name = "Fares", description = "Trip price estimation")
public class FareController {
    private final FareCalculatorClient client;
    private final FareMapper mapper;
    private final PutFareInCacheUseCase putFareInCacheUseCase;

    @PostMapping
    @Operation(summary = "Calculate fare", description = "Calculate fare and optionally cache the result")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Fare calculated", content = @Content(schema = @Schema(implementation = FareResponse.class))),
            @ApiResponse(responseCode = "400", description = "Invalid request")
    })
    public Mono<FareResponse> calculateFare(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(description = "Fare calculation request", required = true,
                    content = @Content(schema = @Schema(implementation = FareRequest.class)))
            @RequestBody FareRequest request) {
        return client.calculateFare(request)
                .map(mapper::toDomain)
                .flatMap(fare -> putFareInCacheUseCase.putFareInCache(fare)
                        .map(isCached -> mapper.toResponse(fare, isCached))
                        .onErrorReturn(mapper.toResponse(fare, false))
                );
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/OfferController.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.domain.ports.in.AcceptedOfferUseCase;
import com.yowyob.rideandgo.domain.ports.in.CreateOfferUseCase;
import com.yowyob.rideandgo.domain.ports.in.ResponseToOfferUseCase;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.CreateOfferRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.OfferResponse;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.RideResponse;
import com.yowyob.rideandgo.infrastructure.mappers.OfferMapper;
import com.yowyob.rideandgo.infrastructure.mappers.RideMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

import java.util.UUID;
import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/offer")
@Tag(name = "Offers", description = "Matchmaking and Bidding workflow")
public class OfferController {
    private final CreateOfferUseCase createOfferUseCase;
    private final ResponseToOfferUseCase responseToOfferUseCase;
    private final AcceptedOfferUseCase acceptedOfferUseCase;
    private final OfferMapper mapper;
    private final RideMapper rideMapper;
    private final ObjectMapper objectMapper;

    @PostMapping
    @Operation(summary = "Create an offer", description = "Create a new offer for a given passenger")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Offer created", content = @Content(schema = @Schema(implementation = OfferResponse.class))),
            @ApiResponse(responseCode = "400", description = "Invalid request")
    })
    public Mono<OfferResponse> createOffer(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(description = "Offer creation payload",
                    required = true,
                    content = @Content(schema = @Schema(implementation = CreateOfferRequest.class)))
            @RequestBody CreateOfferRequest request) {
        Offer offer = mapper.toDomain(request);
        return createOfferUseCase.createOffer(offer, request.passengerId())
                .map(mapper::toResponse);
    }

    @PutMapping
    @Operation(summary = "Respond to an offer", description = "Driver responds to an existing offer")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Offer updated", content = @Content(schema = @Schema(implementation = OfferResponse.class))),
            @ApiResponse(responseCode = "404", description = "Offer not found")
    })
    public Mono<OfferResponse> responseToOffer(
            @Parameter(description = "Offer identifier", required = true) @RequestParam UUID offerId,
            @Parameter(description = "Driver identifier", required = true) @RequestParam UUID driverId) {
        return responseToOfferUseCase.responseToOffer(offerId, driverId)
                .map(this::convertToOffer)
                .map(mapper::toResponse);
    }

    @PostMapping("/validate-offer")
    @Operation(summary = "Accept an offer", description = "Accept an offer to create a ride")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "Ride created", content = @Content(schema = @Schema(implementation = RideResponse.class))),
            @ApiResponse(responseCode = "404", description = "Offer or users not found")
    })
    public Mono<RideResponse> acceptOffer(
            @Parameter(description = "Offer identifier", required = true) @RequestParam UUID offerId,
            @Parameter(description = "Passenger identifier", required = true) @RequestParam UUID passengerId,
            @Parameter(description = "Driver identifier", required = true) @RequestParam UUID driverId) {
        return acceptedOfferUseCase.acceptedOffer(offerId, passengerId, driverId)
                .map(rideMapper::toResponse);
    }

    private Offer convertToOffer(Object instance) {
        if (instance instanceof Offer offer) {
            return offer;
        }
        return objectMapper.convertValue(instance, Offer.class);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/GlobalExceptionHandler.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest;
import org.springframework.http.HttpStatus;
import org.springframework.http.ProblemDetail;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.net.URI;

@RestControllerAdvice
public class GlobalExceptionHandler {

   
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/SendNotificationRequest.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import lombok.Builder;

import java.util.List;
import java.util.Map;

@Builder
public record SendNotificationRequest(
        NotificationType notificationType,
        int templateId,
        List<String> to,
        Map<String, Object> data
) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/RideResponse.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import com.yowyob.rideandgo.domain.model.enums.RideState;
import lombok.Data;

import java.util.UUID;

@Data
public class RideResponse {
    private UUID id;

    private UUID offerId;

    private UUID driverId;

    private UUID passengerId;

    double distance;

    int duration;

    RideState state;

    int timeReal;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/CreateOfferRequest.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import com.yowyob.rideandgo.domain.model.enums.OfferState;

import java.util.UUID;

public record CreateOfferRequest(
        UUID passengerId,
        String startPoint,
        String endPoint,
        double price,
        OfferState state
) {}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/FareRequest.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

public record FareRequest(
        String startLocationName,
        String endLocationName,
        String departureTime) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/CreateUserRequest.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import com.yowyob.rideandgo.domain.model.enums.RoleType;
import lombok.Builder;
import lombok.Data;

@Data @Builder
public class CreateUserRequest {
    private String email;

    private String name;

    private String telephone;

    private String password;

    private RoleType type;
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/UserResponse.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import com.yowyob.rideandgo.domain.model.enums.RoleType;
import lombok.Builder;
import lombok.Data;

import java.util.UUID;

@Data @Builder
public class UserResponse {
    private UUID id;

    private String name;

    private String email;

    private String telephone;

    RoleType role;
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/OfferResponse.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

import com.yowyob.rideandgo.domain.model.enums.OfferState;

import java.util.List;
import java.util.UUID;

public record OfferResponse(
        UUID id,
        UUID passengerId,
        String startPoint,
        String endPoint,
        double price,
        OfferState state,
        List<UUID> interestedDrivers
) {}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/FareResponse.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

public record FareResponse (
        double estimatedFare,
        double officialFare,
        String startLocationName,
        String endLocationName,
        boolean cached) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/dto/NotificationType.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto;

public enum NotificationType {
    EMAIL, SMS, PUSH
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/UserController.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest;

import com.yowyob.rideandgo.application.utils.Utils;
import com.yowyob.rideandgo.domain.model.Role;
import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.domain.ports.in.UserUseCases;
import com.yowyob.rideandgo.domain.ports.out.RoleRepositoryPort;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.CreateUserRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.UserResponse;
import com.yowyob.rideandgo.infrastructure.mappers.UserMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.Collections;
import java.util.Set;
import java.util.UUID;
import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;

@Slf4j
@RestController
@RequiredArgsConstructor
@RequestMapping("/api/v1/users")
@Tag(name = "Users", description = "Operations related to User profiles")
public class UserController {
    private final UserUseCases userUseCases;
    private final UserMapper userMapper;
    private final PasswordEncoder passwordEncoder;
    private final RoleRepositoryPort roleRepository;

    /**
     * Creates a new user and assigns a primary role.
     */
    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create a user", description = "Creates a new user with a specified role type")
    @ApiResponses({
            @ApiResponse(responseCode = "201", description = "User created", content = @Content(schema = @Schema(implementation = UserResponse.class))),
            @ApiResponse(responseCode = "400", description = "Invalid input data")
    })
    public Mono<UserResponse> createUser(
            @io.swagger.v3.oas.annotations.parameters.RequestBody(description = "User creation payload", required = true,
                    content = @Content(schema = @Schema(implementation = CreateUserRequest.class)))
            @RequestBody CreateUserRequest request) {
        
        return roleRepository.findByRoleName(request.getType())
                .flatMap(role -> {
                    User userToSave = User.builder()
                            .id(Utils.generateUUID())
                            .name(request.getName())
                            .email(request.getEmail())
                            .telephone(request.getTelephone())
                            .password(passwordEncoder.encode(request.getPassword()))
                            .roles(Set.of(role)) // Wrap role in a Set for the new RBAC domain model
                            .directPermissions(Collections.emptySet()) // Initialize empty direct permissions
                            .build();

                    return userUseCases.saveUser(userToSave);
                })
                .map(savedUser -> {
                    UserResponse response = userMapper.toResponse(savedUser);
                    // Map the first role type back to the DTO for the frontend
                    if (!savedUser.roles().isEmpty()) {
                        response.setRole(savedUser.roles().iterator().next().type());
                    }
                    return response;
                });
    }

    /**
     * Retrieves a detailed user profile including roles and permissions.
     */
    @GetMapping("/{userId}")
    @Operation(summary = "Get user by id", description = "Retrieve a user profile by its UUID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "User found", content = @Content(schema = @Schema(implementation = UserResponse.class))),
            @ApiResponse(responseCode = "404", description = "User not found")
    })
    public Mono<UserResponse> getUserById(
            @Parameter(description = "User identifier", required = true) @PathVariable UUID userId) {
        log.info("Fetching user details for id: {}", userId);
        
        return userUseCases.getUserById(userId)
                .map(user -> {
                    UserResponse response = userMapper.toResponse(user);
                    // Set the primary role type in the DTO
                    if (user.roles() != null && !user.roles().isEmpty()) {
                        response.setRole(user.roles().iterator().next().type());
                    }
                    return response;
                });
    }

    /**
     * Lists all users, optionally filtered by their primary role.
     */
    @GetMapping
    @Operation(summary = "List users", description = "Get all users or filter by their primary role")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "List of users", content = @Content(schema = @Schema(implementation = UserResponse.class)))
    })
    public Flux<UserResponse> getAllUsers(
            @Parameter(description = "Optional role filter") @RequestParam(required = false) RoleType role) {
        
        Flux<User> userFlux = (role != null) ? userUseCases.getUsersByRole(role) : userUseCases.getAllUsers();

        return userFlux.map(user -> {
            UserResponse response = userMapper.toResponse(user);
            if (user.roles() != null && !user.roles().isEmpty()) {
                response.setRole(user.roles().iterator().next().type());
            }
            return response;
        });
    }

    /**
     * Deletes a user from the system.
     */
    @DeleteMapping("/{id}")
    @Operation(summary = "Delete user", description = "Permanently delete a user by its UUID")
    @ApiResponses({
            @ApiResponse(responseCode = "200", description = "User successfully deleted"),
            @ApiResponse(responseCode = "404", description = "User not found")
    })
    public Mono<Boolean> deleteById(
            @Parameter(description = "User identifier", required = true) @PathVariable UUID id) {
        log.info("Deleting user with id: {}", id);
        return userUseCases.deleteUserById(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/adapters/inbound/rest/HealthCheckController.java`
```java
package com.yowyob.rideandgo.infrastructure.adapters.inbound.rest;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.r2dbc.core.DatabaseClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

import java.util.Map;

@RestController
@RequestMapping("/api/v1/health")
@RequiredArgsConstructor
@Tag(name = "Health", description = "System diagnostic and connectivity checks")
public class HealthCheckController {

    private final DatabaseClient databaseClient;

    /**
     * Probes the database to ensure the R2DBC connection is active.
     */
    @GetMapping("/check-db")
    @Operation(summary = "Check database connectivity", description = "Executes a simple query to verify the DB link")
    public Mono<Map<String, Object>> checkDatabase() {
        return databaseClient.sql("SELECT 1")
                .map((row, metadata) -> row.get(0))
                .first()
                // Explicitly tell Java to treat this as a Map<String, Object>
                .map(res -> Map.<String, Object>of(
                        "status", "UP",
                        "database", "CONNECTED",
                        "message", "Database is responding correctly"
                ))
                .onErrorReturn(Map.of(
                        "status", "DOWN",
                        "database", "DISCONNECTED",
                        "message", "Could not connect to the database"
                ));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/WebClientConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import com.yowyob.rideandgo.infrastructure.adapters.outbound.external.client.FareCalculatorClient;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.support.WebClientAdapter;
import org.springframework.web.service.invoker.HttpServiceProxyFactory;

@Configuration
public class WebClientConfig {

  
    @Bean
    public FareCalculatorClient fareCalculatorClient(WebClient.Builder builder,
                                         @Value("${application.external.fare-calculator-url}") String url) {

        WebClient webClient = builder.baseUrl(url).build();
        WebClientAdapter adapter = WebClientAdapter.create(webClient);
        HttpServiceProxyFactory factory = HttpServiceProxyFactory.builderFor(adapter).build();

        return factory.createClient(FareCalculatorClient.class);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/SecurityConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.core.userdetails.MapReactiveUserDetailsService;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.server.SecurityWebFilterChain;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {

    /**
     * Configures the security filter chain for WebFlux.
     * Defines which paths are public and which are secured.
     */
    @Bean
    public SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
        System.out.println("ðŸ›¡ï¸ REACTIVE SECURITY CONFIGURATION LOADED");

        return http
                // Disable CSRF for stateless REST APIs
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                
                .authorizeExchange(exchanges -> exchanges
                        // Public endpoints: Monitoring and Health
                        .pathMatchers("/actuator/**", "/api/v1/health/**").permitAll()
                        
                        // Public endpoints: API Documentation (Swagger)
                        .pathMatchers(
                                "/v3/api-docs/**", 
                                "/swagger-ui/**", 
                                "/swagger-ui.html", 
                                "/webjars/**"
                        ).permitAll()
                        
                        // All other business endpoints require authentication
                        .anyExchange().authenticated()
                )
                
                // Disable default login mechanisms
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .build();
    }

    /**
     * Password encoder used for user credential hashing.
     */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * Dummy user details service to prevent Spring from logging 
     * a generated security password on every startup.
     */
    @Bean
    public MapReactiveUserDetailsService userDetailsService() {
        UserDetails dummy = User.withUsername("tech_user")
                .password("{noop}secret")
                .roles("SYSTEM")
                .build();
        return new MapReactiveUserDetailsService(dummy);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/RedisConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.module.paramnames.ParameterNamesModule;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.data.redis.serializer.*;

@Configuration
public class RedisConfig {

    @Bean
    public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
            ReactiveRedisConnectionFactory factory) {

        ObjectMapper mapper = new ObjectMapper()
                .registerModule(new ParameterNamesModule())
                .registerModule(new JavaTimeModule());

        Jackson2JsonRedisSerializer<Object> jsonSerializer =
                new Jackson2JsonRedisSerializer<>(mapper, Object.class);

        RedisSerializationContext<String, Object> context =
                RedisSerializationContext.<String, Object>newSerializationContext(new StringRedisSerializer())
                        .value(jsonSerializer)
                        .hashValue(jsonSerializer)
                        .build();

        return new ReactiveRedisTemplate<>(factory, context);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/KafkaConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.common.serialization.StringSerializer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import reactor.kafka.sender.SenderOptions;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class KafkaConfig {

    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Bean
    public ReactiveKafkaProducerTemplate<String, Object> reactiveKafkaProducerTemplate() {
        Map<String, Object> props = new HashMap<>();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, org.springframework.kafka.support.serializer.JsonSerializer.class);

        SenderOptions<String, Object> senderOptions = SenderOptions.create(props);

        return new ReactiveKafkaProducerTemplate<>(senderOptions);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/DatabaseInitConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.io.ClassPathResource;
import org.springframework.r2dbc.core.DatabaseClient;
import jakarta.annotation.PostConstruct;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.stream.Collectors;

@Configuration
@Profile("local") // Only active in local development
public class DatabaseInitConfig {

    private final DatabaseClient databaseClient;

    public DatabaseInitConfig(DatabaseClient databaseClient) {
        this.databaseClient = databaseClient;
    }

    @PostConstruct
    public void init() {
        System.out.println("âš™ï¸ LOCAL ENVIRONMENT: Starting sequential database initialization...");

        // 1. Run Schema -> 2. Check if users exist -> 3. Run Seeding if empty
        executeSqlFile("local/schema.sql")
                .then(checkIfDataExists())
                .flatMap(hasData -> {
                    if (!hasData) {
                        System.out.println("ðŸŒ± Database is empty. Injecting seed data...");
                        return executeSqlFile("local/data.sql");
                    }
                    System.out.println("âœ… Database already has data. Skipping seeding.");
                    return Mono.empty();
                })
                .subscribe(
                        null,
                        err -> System.err.println("âŒ Local DB Init Error: " + err.getMessage()),
                        () -> System.out.println("ðŸš€ LOCAL DATABASE READY!")
                );
    }

    /**
     * Reads a SQL file and executes each statement sequentially using concatMap.
     */
    private Mono<Void> executeSqlFile(String filePath) {
        return Mono.fromCallable(() -> {
            ClassPathResource resource = new ClassPathResource(filePath);
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(resource.getInputStream()))) {
                return reader.lines().collect(Collectors.joining("\n"));
            }
        })
        .flatMapMany(sql -> Flux.fromArray(sql.split(";")))
        .map(String::trim)
        .filter(s -> !s.isEmpty())
        .concatMap(s -> databaseClient.sql(s).then()) // Execute in strict sequence
        .then();
    }

    /**
     * Checks if the central 'users' table is populated.
     */
    private Mono<Boolean> checkIfDataExists() {
        return databaseClient.sql("SELECT COUNT(*) FROM users")
                .map((row, metadata) -> row.get(0, Long.class))
                .first()
                .map(count -> count > 0)
                .onErrorReturn(false); // If table doesn't exist, consider it empty
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/infrastructure/config/OpenApiConfig.java`
```java
package com.yowyob.rideandgo.infrastructure.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.License;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("YowYob Microservice Template API")
                        .version("1.0.0")
                        .description("Documentation de l'API RÃ©active Hexagonale.")
                        .contact(new Contact()
                                .name("Ã‰quipe Backend")
                                .email("dev@yowyob.com"))
                        .license(new License()
                                .name("Apache 2.0")
                                .url("http://springdoc.org")));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/exception/OfferStatutNotMatchException.java`
```java
package com.yowyob.rideandgo.domain.exception;

public class OfferStatutNotMatchException extends RuntimeException{
    public OfferStatutNotMatchException(String message) {
        super(message);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/exception/UserIsNotDriverException.java`
```java
package com.yowyob.rideandgo.domain.exception;

public class UserIsNotDriverException extends RuntimeException{
    public UserIsNotDriverException(String message) {
        super(message);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/exception/TokenNotFoundException.java`
```java
package com.yowyob.rideandgo.domain.exception;

public class TokenNotFoundException extends RuntimeException{
    public TokenNotFoundException(String message) {
        super(message);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/exception/OfferNotFoundException.java`
```java
package com.yowyob.rideandgo.domain.exception;

public interface OfferNotFoundException {
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/Ride.java`
```java
package com.yowyob.rideandgo.domain.model;

import com.yowyob.rideandgo.domain.model.enums.RideState;
import lombok.Builder;

import java.util.UUID;

@Builder
public record Ride(
        UUID id,
        UUID offerId,
        UUID passengerId,
        UUID driverId,
        double distance,
        int duration,
        RideState state,
        int timeReal) {}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/enums/OfferState.java`
```java
package com.yowyob.rideandgo.domain.model.enums;

/**
 * Lifecycle states of a transport Offer as defined in spec.md
 */
public enum OfferState {
    /** Initial state, waiting for drivers */
    PENDING,
    
    /** At least one driver applied */
    BID_RECEIVED,
    
    /** Passenger chose a driver */
    DRIVER_SELECTED,
    
    /** Driver confirmed, offer is closed and becomes a Ride */
    VALIDATED,
    
    /** Cancelled or expired */
    CANCELLED
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/enums/RoleType.java`
```java
package com.yowyob.rideandgo.domain.model.enums;

public enum RoleType {
    PASSENGER, DRIVER, ADMIN
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/enums/RideState.java`
```java
package com.yowyob.rideandgo.domain.model.enums;

/**
 * Lifecycle states of a Trip (Ride) as defined in spec.md
 */
public enum RideState {
    /** Ride initialized, driver approaching passenger */
    CREATED,
    
    /** Passenger picked up, trip in progress */
    ONGOING,
    
    /** Trip finished at destination */
    COMPLETED,
    
    /** Trip interrupted or cancelled */
    CANCELLED
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/Fare.java`
```java
package com.yowyob.rideandgo.domain.model;

import java.util.UUID;

public record Fare(
        UUID id,
        UUID userId,
        String startPoint,
        String endPoint,
        Double estimatedFare,
        Double  officialFare
) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/Role.java`
```java
package com.yowyob.rideandgo.domain.model;

import com.yowyob.rideandgo.domain.model.enums.RoleType;
import java.util.Set;
import java.util.UUID;
import lombok.Builder;

@Builder
public record Role(
    UUID id, 
    RoleType type,
    Set<Permission> permissions
) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/Permission.java`
```java
package com.yowyob.rideandgo.domain.model;
import java.util.UUID;

public record Permission(UUID id, String name) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/User.java`
```java
package com.yowyob.rideandgo.domain.model;

import lombok.Builder;
import java.util.Set;
import java.util.UUID;

@Builder
public record User(
    UUID id,
    String name,
    String email,
    String telephone,
    String password,
    Set<Role> roles,
    Set<Permission> directPermissions
) {}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/model/Offer.java`
```java
package com.yowyob.rideandgo.domain.model;

import com.yowyob.rideandgo.domain.model.enums.OfferState;
import lombok.Builder;

import java.util.List;
import java.util.UUID;

@Builder
public record Offer(
        UUID id,
        UUID passengerId,
        String startPoint,
        String endPoint,
        double price,
        OfferState state,
        List<UUID> interestedDrivers,
        Long version) {

    public Offer withInterestedDriversAndState(List<UUID> interestedDrivers, OfferState state) {
        return new Offer(this.id, this.passengerId, this.startPoint, this.endPoint, this.price, state, interestedDrivers, this.version);
    }

    public Offer withInterestedDrivers(List<UUID> interestedDrivers) {
        return new Offer(this.id, this.passengerId, this.startPoint, this.endPoint, this.price, this.state, interestedDrivers, this.version);
    }

    public Offer withState(OfferState state) {
        return new Offer(this.id, this.passengerId, this.startPoint, this.endPoint, this.price, state, this.interestedDrivers, this.version);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/in/UserUseCases.java`
```java
package com.yowyob.rideandgo.domain.ports.in;

import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface UserUseCases {
    Mono<User> saveUser(User user);

    Mono<User> getUserById(UUID userId);

    Mono<Boolean> deleteUserById(UUID userId);

    Flux<User> getAllUsers();

    Flux<User> getUsersByRole(RoleType role);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/in/ResponseToOfferUseCase.java`
```java
package com.yowyob.rideandgo.domain.ports.in;

import com.yowyob.rideandgo.domain.model.Offer;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface ResponseToOfferUseCase {
    Mono<Offer> responseToOffer(UUID offerId, UUID driverId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/in/PutFareInCacheUseCase.java`
```java
package com.yowyob.rideandgo.domain.ports.in;

import com.yowyob.rideandgo.domain.model.Fare;
import reactor.core.publisher.Mono;

public interface PutFareInCacheUseCase {
    Mono<Boolean> putFareInCache(Fare fare);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/in/CreateOfferUseCase.java`
```java
package com.yowyob.rideandgo.domain.ports.in;

import com.yowyob.rideandgo.domain.model.Fare;
import com.yowyob.rideandgo.domain.model.Offer;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface CreateOfferUseCase {
    Mono<Offer> createOffer(Offer offer, UUID passengerId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/in/AcceptedOfferUseCase.java`
```java
package com.yowyob.rideandgo.domain.ports.in;

import com.yowyob.rideandgo.domain.model.Ride;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface AcceptedOfferUseCase {
    Mono<Ride> acceptedOffer(UUID offerId, UUID passengerId, UUID driverId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/FareCachePort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Fare;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface FareCachePort {
    Mono<Boolean> saveInCache(Fare fare);

    Mono<Fare> findFareById(UUID fareId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/OfferRepositoryPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Offer;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface OfferRepositoryPort {
    Mono<Offer> save(Offer offer);

    Mono<Boolean> delete(Offer offer);

    Mono<Boolean> exists(Offer offer);

    Mono<Offer> findById(UUID offerId);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/RoleRepositoryPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Role;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface RoleRepositoryPort {
    Mono<Role> findRoleById(UUID roleId);

    Mono<Role> findByRoleName(RoleType type);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/UserRepositoryPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.UUID;

public interface UserRepositoryPort {
    Mono<User> save(User user);

    Mono<Boolean> delete(User user);

    Mono<Boolean> deleteById(UUID userId);

    Mono<Boolean> exists(User user);

    Mono<User> findUserById(UUID userId);

    Flux<User> findByRoleName(RoleType role);

    Flux<User> findAll();

}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/UserCachePort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.User;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface UserCachePort {
    Mono<Boolean> saveInCache(User user);

    Mono<User> findUserById(UUID userId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/OfferCachePort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Offer;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface OfferCachePort {
    Mono<Boolean> saveInCache(Offer offer);

    Mono<Offer> findOfferById(UUID offerId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/StockClientPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import reactor.core.publisher.Mono;

public interface StockClientPort {
    /**
     * Verify if te stock is full.
     * @return true full, false otherwise
     */
    Mono<Boolean> isStockFull(String productName);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/RideRepositoryPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Ride;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface RideRepositoryPort {
    Mono<Ride> save(Ride ride);

    Mono<Ride> findRideById(UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/OfferEventPublisherPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.domain.model.Offer;
import reactor.core.publisher.Mono;

public interface OfferEventPublisherPort {
    Mono<Void> publishOfferCreatedEvent(Offer offer);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/FareClientPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareRequest;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.FareResponse;
import reactor.core.publisher.Mono;

public interface FareClientPort {
    Mono<FareResponse> caclculateFare(FareRequest request);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/domain/ports/out/SendNotificationPort.java`
```java
package com.yowyob.rideandgo.domain.ports.out;

import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.SendNotificationRequest;
import reactor.core.publisher.Mono;

public interface SendNotificationPort {
    Mono<Boolean> sendNotification(SendNotificationRequest request);
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/application/utils/Constants.java`
```java
package com.yowyob.rideandgo.application.utils;

public class Constants {
    public static final String NOTIFICATION_SERVICE_TOKEN_HEADER = "X-Service-Token";
}
```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/application/utils/Utils.java`
```java
package com.yowyob.rideandgo.application.utils;

import java.util.UUID;

public class Utils {
    public static UUID generateUUID(){
        return UUID.randomUUID();
    }

    public static int generateRandomNumber(){
        return (int) (Math.random()*100);
    }

    public static int generateRandomNumber(int max){
        return (int) (Math.random()*max);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/application/service/OfferService.java`
```java
package com.yowyob.rideandgo.application.service;

import com.yowyob.rideandgo.application.utils.Utils;
import com.yowyob.rideandgo.domain.exception.OfferStatutNotMatchException;
import com.yowyob.rideandgo.domain.exception.UserIsNotDriverException;
import com.yowyob.rideandgo.domain.model.Offer;
import com.yowyob.rideandgo.domain.model.Ride;
import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.enums.OfferState;
import com.yowyob.rideandgo.domain.model.enums.RideState;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.domain.ports.in.AcceptedOfferUseCase;
import com.yowyob.rideandgo.domain.ports.in.CreateOfferUseCase;
import com.yowyob.rideandgo.domain.ports.in.ResponseToOfferUseCase;
import com.yowyob.rideandgo.domain.ports.out.*;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.NotificationType;
import com.yowyob.rideandgo.infrastructure.adapters.inbound.rest.dto.SendNotificationRequest;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.util.*;

@Slf4j
@Service
@RequiredArgsConstructor
public class OfferService implements CreateOfferUseCase, ResponseToOfferUseCase, AcceptedOfferUseCase {
    private final OfferCachePort cache;
    private final OfferRepositoryPort repository;
    private final UserRepositoryPort userRepositoryPort;
    private final SendNotificationPort sendNotificationPort;
    private final RideRepositoryPort rideRepositoryPort;

    @Value("${application.kafka.notification-service.template.new-offer-id}")
    private int templateCreateOfferId;

    /**
     * UC-01: Creates a new offer and notifies all available drivers via Kafka/Email.
     */
    @Override
    public Mono<Offer> createOffer(Offer request, UUID passengerId) {
        Offer offer = Offer.builder()
                .id(Utils.generateUUID())
                .passengerId(passengerId)
                .startPoint(request.startPoint())
                .endPoint(request.endPoint())
                .price(request.price())
                .state(OfferState.PENDING) // Initial state according to spec
                .interestedDrivers(new ArrayList<>())
                .build();

        return repository.save(offer)
                .flatMap(savedOffer -> 
                    // Fetch all driver emails from the central database
                    userRepositoryPort.findByRoleName(RoleType.DRIVER)
                        .map(User::email)
                        .collectList()
                        .flatMap(driverEmails -> {
                            SendNotificationRequest notification = SendNotificationRequest.builder()
                                    .notificationType(NotificationType.EMAIL)
                                    .templateId(templateCreateOfferId)
                                    .to(driverEmails)
                                    .data(Map.of("price", offer.price(), "from", offer.startPoint(), "to", offer.endPoint()))
                                    .build();

                            // Parallel: Notify and Cache
                            return Mono.zip(
                                sendNotificationPort.sendNotification(notification),
                                cache.saveInCache(savedOffer)
                            ).thenReturn(savedOffer);
                        })
                )
                .doOnSuccess(o -> log.info("Offer successfully created: {}", o.id()));
    }

    /**
     * UC-02 Part 1: Allows a driver to apply for an offer (Manifest interest).
     */
    @Override
    public Mono<Offer> responseToOffer(UUID offerId, UUID driverId) {
        log.info("Driver {} applying for offer {}", driverId, offerId);
        
        return repository.findById(offerId)
                .flatMap(offer -> userRepositoryPort.findUserById(driverId)
                        .flatMap(user -> {
                            // Check if the user has the DRIVER role in the new Set-based model
                            boolean isDriver = user.roles().stream()
                                    .anyMatch(role -> role.type() == RoleType.DRIVER);

                            if (!isDriver) {
                                return Mono.error(new UserIsNotDriverException("User " + driverId + " is not authorized to drive."));
                            }

                            List<UUID> driverIds = new ArrayList<>(offer.interestedDrivers());
                            if (!driverIds.contains(driverId)) {
                                driverIds.add(driverId);
                            }

                            Offer updated = offer.withInterestedDriversAndState(driverIds, OfferState.BID_RECEIVED);
                            
                            return repository.save(updated)
                                    .flatMap(s -> cache.saveInCache(s).thenReturn(s));
                        })
                );
    }

    /**
     * UC-02 Part 2: Passenger selects a driver, offer is validated and becomes a Ride.
     */
    @Override
    public Mono<Ride> acceptedOffer(UUID offerId, UUID passengerId, UUID driverId) {
        return repository.findById(offerId)
                .flatMap(offer -> {
                    // Business rules validation
                    if (offer.state() != OfferState.BID_RECEIVED && offer.state() != OfferState.DRIVER_SELECTED) {
                        return Mono.error(new OfferStatutNotMatchException("Offer must be in BID_RECEIVED state to be validated."));
                    }
                    if (!offer.interestedDrivers().contains(driverId)) {
                        return Mono.error(new IllegalArgumentException("Driver has not applied to this offer."));
                    }

                    // Move offer to final state
                    Offer validatedOffer = offer.withState(OfferState.VALIDATED);
                    return repository.save(validatedOffer);
                })
                .flatMap(offer -> {
                    // Create the Trip context (Section 6 of spec.md)
                    Ride ride = Ride.builder()
                            .id(Utils.generateUUID())
                            .offerId(offer.id())
                            .passengerId(passengerId)
                            .driverId(driverId)
                            .state(RideState.CREATED) // Initial trip state
                            .build();

                    return rideRepositoryPort.save(ride);
                })
                .doOnSuccess(r -> log.info("Trip successfully created for offer {}", offerId));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/application/service/UserService.java`
```java
package com.yowyob.rideandgo.application.service;

import com.yowyob.rideandgo.domain.model.User;
import com.yowyob.rideandgo.domain.model.enums.RoleType;
import com.yowyob.rideandgo.domain.ports.in.UserUseCases;
import com.yowyob.rideandgo.domain.ports.out.UserRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Service
@RequiredArgsConstructor
public class UserService implements UserUseCases {

    private final UserRepositoryPort userRepositoryPort;

    @Override
    public Mono<User> saveUser(User user) {
        return userRepositoryPort.save(user);
    }

    @Override
    public Mono<User> getUserById(UUID userId) {
        return userRepositoryPort.findUserById(userId);
    }

    @Override
    public Mono<Boolean> deleteUserById(UUID userId) {
        return userRepositoryPort.deleteById(userId);
    }

    @Override
    public Flux<User> getAllUsers() {
        return userRepositoryPort.findAll();
    }

    @Override
    public Flux<User> getUsersByRole(RoleType role) {
        return userRepositoryPort.findByRoleName(role);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/rideandgo/application/service/FareService.java`
```java
package com.yowyob.rideandgo.application.service;

import com.yowyob.rideandgo.domain.model.Fare;
import com.yowyob.rideandgo.domain.ports.in.PutFareInCacheUseCase;
import com.yowyob.rideandgo.domain.ports.out.FareCachePort;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

@Slf4j
@Service
@RequiredArgsConstructor
public class FareService implements PutFareInCacheUseCase {

    private final FareCachePort fareCachePort;

    @Override
    public Mono<Boolean> putFareInCache(Fare fare) {
        return fareCachePort.saveInCache(fare);
    }
}```

---
### Fichier : `./.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./Readme.md`
```md
# Template Hexagonal Reactive - com.yowyob

Ce projet est le **socle standard** pour le dÃ©veloppement de microservices backend chez **com.yowyob**. Il fournit une structure clÃ© en main respectant les principes de l'**Architecture Hexagonale** sur une stack technologique entiÃ¨rement **RÃ©active** (Non-bloquante).

## ðŸ“˜ Ã€ propos de ce Template

### Objectif
L'objectif de ce repository n'est pas d'Ãªtre un simple "Hello World", mais de fournir un **exemple complet et rÃ©aliste** d'un microservice de production. Il a Ã©tÃ© rÃ©alisÃ© pour standardiser nos dÃ©veloppements, assurer la cohÃ©rence du code entre les Ã©quipes et faciliter la maintenance.

### ScÃ©nario d'implÃ©mentation (Comment il a Ã©tÃ© rÃ©alisÃ©)
Pour dÃ©montrer les capacitÃ©s du template, nous avons implÃ©mentÃ© un cas d'usage fonctionnel complet : **"La crÃ©ation d'un produit"**.

Ce scÃ©nario a Ã©tÃ© choisi car il traverse toutes les couches techniques nÃ©cessaires dans un vrai systÃ¨me distribuÃ© :

1.  **EntrÃ©e API** : RÃ©ception d'une requÃªte POST (Layer REST).
2.  **Validation MÃ©tier** : Appel Ã  un service externe (Stock Service) pour vÃ©rifier la capacitÃ© via HTTP.
3.  **Persistance** : Sauvegarde des donnÃ©es dans PostgreSQL (R2DBC).
4.  **Performance** : Mise en cache du rÃ©sultat dans Redis.
5.  **Communication Asynchrone** : Publication d'un Ã©vÃ©nement "ProductCreated" dans Kafka.
6.  **RÃ©silience** : Gestion des pannes du service externe via un Circuit Breaker.

Ce flux permet aux dÃ©veloppeurs de voir concrÃ¨tement comment enchaÃ®ner ces opÃ©rations de maniÃ¨re rÃ©active (Reactor/Mono/Flux) tout en gardant le cÅ“ur du mÃ©tier pur.

---

## ðŸ“‹ PrÃ©requis

- **Java 21**
- **Maven 3.8+**
- **Docker** (Optionel)

## ðŸ— Architecture du Projet

L'architecture est divisÃ©e en trois couches distinctes pour isoler la logique mÃ©tier des technologies.

### 1. Domain (`src/main/java/com/yowyob/template/domain`)
C'est le cÅ“ur du mÃ©tier. **Aucune dÃ©pendance Spring** ne doit se trouver ici (sauf exception rare).
- **`model/`** : Les objets mÃ©tiers (Records Java).
- **`ports/in/`** : Les interfaces (Use Cases) dÃ©finissant ce que l'application *peut faire* (ex: `CreateProductUseCase`).
- **`ports/out/`** : Les interfaces dÃ©finissant ce dont l'application *a besoin* (ex: Repository, Client API, Bus d'Ã©vÃ©nements).
- **`exception/`** : Exceptions mÃ©tier.

### 2. Application (`src/main/java/com/yowyob/template/application`)
L'orchestrateur.
- ImplÃ©mente les interfaces `ports/in`.
- Utilise les interfaces `ports/out`.
- Contient la logique des flux (Flows reactor).

### 3. Infrastructure (`src/main/java/com/yowyob/template/infrastructure`)
Tout ce qui est technique. C'est ici qu'on implÃ©mente Spring, les bases de donnÃ©es, etc.
- **`adapters/inbound/`** : Ce qui *entre* dans l'app (Controlleurs REST, Listeners Kafka).
- **`adapters/outbound/`** : Ce qui *sort* ou stocke (ImplÃ©mentation R2DBC, Client WebClient, Redis, Kafka Producer).
- **`config/`** : Configuration Spring (Beans, Security, Serializers).
- **`mappers/`** : Conversion entre les DTOs, les EntitÃ©s et le Domaine (MapStruct).


## âš™ï¸ Configuration et URLs Externes

La configuration est centralisÃ©e dans `src/main/resources/application.yml`.

### Comment dÃ©finir l'URL d'un Microservice externe ?

Pour appeler un autre service (ex: Stock Service), nous utilisons `WebClient` configurÃ© via une interface dÃ©clarative (Http Interface Client).

1. **DÃ©finir l'URL dans le YAML** :
   Dans `application.yml` (ou `prod.application.yml`), localisez la section `application.external` :
   ```yaml
   application:
     external:
       stock-service-url: http://168.119.122.86:8081
   ```

2. **Injection dans le Client** :
   Dans `WebClientConfig.java`, cette valeur est injectÃ©e via `@Value("${application.external.stock-service-url}")` et passÃ©e au builder du client HTTP.

3. **Utilisation** :
   L'adaptateur (`StockAdapter`) utilise l'interface `StockApiClient` sans se soucier de l'URL.

### Configuration Infrastructure (DB, Redis, Kafka)

Les accÃ¨s aux services de donnÃ©es sont dÃ©finis dans les fichiers YAML.
- **Profil par dÃ©faut (`application.yml`)** : ConfigurÃ© pour le dÃ©veloppement (Redis standalone).
- **Profil Prod (`prod.application.yml`)** : ConfigurÃ© pour la production (Redis Cluster, IPs statiques).

---

## ðŸš€ Comment Lancer l'Application

### 1. En local (DÃ©veloppement)

Assurez-vous que vos services (Postgres, Kafka, Redis) sont accessibles aux adresses dÃ©finies dans `application.yml`.

```bash
mvn clean install
mvn spring-boot:run
```

### 2. Via Docker

Pour construire l'image et lancer un conteneur :

```bash
# Construire l'image
docker build -t reactive-hexagonal .

# Lancer (en pointant vers le profil prod par exemple)
docker run -p 8080:8080 -e SPRING_PROFILES_ACTIVE=prod reactive-hexagonal
```

---

## ðŸ›  Guide du DÃ©veloppeur : Comment ajouter une fonctionnalitÃ© ?

Si vous devez ajouter une fonctionnalitÃ© (ex: "Supprimer un produit"), suivez cet ordre strict :

1.  **Domain (Port In)** : CrÃ©ez l'interface `DeleteProductUseCase` dans `domain/ports/in`.
2.  **Domain (Port Out)** : Si besoin d'accÃ¨s DB, crÃ©ez/maj `ProductRepositoryPort` dans `domain/ports/out`.
3.  **Application** : ImplÃ©mentez le UseCase dans `ProductService` (ou un nouveau service `DeleteProductService`).
4.  **Infrastructure (Out)** : ImplÃ©mentez la mÃ©thode de suppression dans `PostgresR2dbcAdapter`.
5.  **Infrastructure (In)** : Ajoutez l'endpoint `DELETE` dans `ProductController`.

### RÃ©silience (Circuit Breaker)

Les appels externes sont protÃ©gÃ©s par Resilience4j.
Pour modifier les seuils (ex: passer Ã  10s d'attente), modifiez la section `resilience4j` dans le fichier YAML.

```yaml
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50 # Ouvre le circuit si 50% d'Ã©checs
```

---

## âœ… VÃ©rifications avant commit

- [ ] Les DTOs (Infrastructure) sont sÃ©parÃ©s des Objets du Domaine (Domain).
- [ ] Aucune annotation Spring (`@Service`, `@Component`) dans le package `domain`.
- [ ] Les tests unitaires couvrent la couche Application.

## ðŸ“š Documentation de l'API (Swagger UI)

Le projet intÃ¨gre **OpenAPI 3** (via Springdoc) pour documenter et tester les endpoints automatiquement.

Une fois l'application lancÃ©e, la documentation est accessible ici :

- **Interface Visuelle (Swagger UI)** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **DÃ©finition JSON (OpenAPI)** : [http://localhost:8080/v3/api-docs](http://localhost:8080/v3/api-docs)```

---
### Fichier : `./pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>ride-and-go</name>
    <description>API Ride and Go - Marketplace de transport urbain</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
	    <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>
	<dependency>
	     <groupId>io.micrometer</groupId>
	     <artifactId>micrometer-registry-prometheus</artifactId>
	</dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>
        <!-- SPRING SECURITY REACTIVE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <!-- SECURITY TESTING -->
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

---
### Fichier : `./.github/workflows/ci-cd.yml`
```yaml
name: Spring Boot CI/CD

on:
  push:
    branches:
      - "**"
      #- main

env:
  REGISTRY_IMAGE: ghcr.io/${{ github.repository_owner }}/ride-and-go
  APP_NAME: ride-and-go
  HEALTH_DELAY: ${{ secrets.DEPLOY_DELAY }}
  CONTAINER_NAME: ride-and-go

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Run Unit Tests + SonarQube Analysis
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${{ env.APP_NAME }} \
            -Dsonar.projectName=${{ env.APP_NAME }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}

  build:
    needs: tests
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.PERSONAL_ACCESS_TOKEN }}" | docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} --password-stdin

      - name: Use prod.application.yml
        run: |
          echo "Using prod.application.yml"
          rm src/main/resources/application.yml
          mv src/main/resources/prod.application.yml src/main/resources/application.yml
          cat src/main/resources/application.yml

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ env.REGISTRY_IMAGE }}:latest .

      - name: Push Docker image
        run: |
          echo "Pushing Docker image..."
          docker push ${{ env.REGISTRY_IMAGE }}:latest


  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'

            echo "Pulling latest image ${{ env.REGISTRY_IMAGE }}"

            docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} -p ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            cd /root/projet_synthese/infra

            echo "Stopping container"
            docker compose down ${{ env.CONTAINER_NAME }}

            echo "Removing old image"
            docker rmi -f ${{ env.REGISTRY_IMAGE }}:latest || true

            echo "Pulling new image"
            docker pull ${{ env.REGISTRY_IMAGE }}:latest

            echo " Starting container"
            docker compose up -d ${{ env.CONTAINER_NAME }}

            echo " Waiting ${{ env.HEALTH_DELAY }} seconds for health check"
            sleep ${{ env.HEALTH_DELAY }}

            echo " Checking container health..."
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' ${{ env.CONTAINER_NAME }})

            echo "Health status: $STATUS"

            if [ "$STATUS" != "\"healthy\"" ]; then
              echo "ERROR: Container is not healthy"
              exit 1
            fi

            echo "Deployment successful & container healthy!"
          EOF
```
